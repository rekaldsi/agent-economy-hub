<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Wallet Test - TheBotique</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0a0a0f;
      color: #e0e0e0;
      min-height: 100vh;
      padding: 20px;
    }
    .container { max-width: 600px; margin: 0 auto; }
    h1 { color: #00F0FF; margin-bottom: 20px; font-size: 24px; }
    .card {
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }
    .card h2 { font-size: 16px; margin-bottom: 15px; color: #888; }
    .status {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }
    .dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #666;
    }
    .dot.green { background: #00ff88; }
    .dot.red { background: #ff4444; }
    .dot.yellow { background: #ffaa00; }
    button {
      background: linear-gradient(135deg, #00F0FF, #00a0aa);
      color: #000;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      width: 100%;
      margin-top: 10px;
      font-size: 16px;
    }
    button:hover { opacity: 0.9; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    .log {
      background: #000;
      border-radius: 8px;
      padding: 15px;
      font-family: monospace;
      font-size: 12px;
      max-height: 300px;
      overflow-y: auto;
      white-space: pre-wrap;
      word-break: break-all;
    }
    .log-entry { margin-bottom: 5px; }
    .log-entry.error { color: #ff6b6b; }
    .log-entry.success { color: #51cf66; }
    .log-entry.info { color: #74c0fc; }
    .address {
      font-family: monospace;
      font-size: 14px;
      word-break: break-all;
      color: #00F0FF;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ðŸ”§ Wallet Connection Test</h1>
    
    <div class="card">
      <h2>ENVIRONMENT</h2>
      <div class="status">
        <div class="dot" id="dot-ethereum"></div>
        <span>window.ethereum: <span id="has-ethereum">checking...</span></span>
      </div>
      <div class="status">
        <div class="dot" id="dot-provider"></div>
        <span>Provider: <span id="provider-name">unknown</span></span>
      </div>
      <div class="status">
        <div class="dot" id="dot-chain"></div>
        <span>Chain ID: <span id="chain-id">-</span></span>
      </div>
    </div>

    <div class="card">
      <h2>CONNECTION</h2>
      <div class="status">
        <div class="dot" id="dot-connected"></div>
        <span>Status: <span id="connection-status">disconnected</span></span>
      </div>
      <div id="address-display" style="display:none; margin-top:10px;">
        <span style="color:#888;">Address:</span><br>
        <span class="address" id="wallet-address"></span>
      </div>
      <button id="connect-btn" onclick="testConnect()">Connect Wallet</button>
    </div>

    <div class="card">
      <h2>DEBUG LOG</h2>
      <div class="log" id="log"></div>
    </div>
  </div>

  <script>
    const log = (msg, type = 'info') => {
      const logEl = document.getElementById('log');
      const entry = document.createElement('div');
      entry.className = 'log-entry ' + type;
      entry.textContent = new Date().toLocaleTimeString() + ' | ' + msg;
      logEl.appendChild(entry);
      logEl.scrollTop = logEl.scrollHeight;
    };

    const updateDot = (id, color) => {
      document.getElementById(id).className = 'dot ' + color;
    };

    // Check environment on load
    window.addEventListener('load', async () => {
      log('Page loaded, checking environment...');
      
      // Check window.ethereum
      if (typeof window.ethereum !== 'undefined') {
        updateDot('dot-ethereum', 'green');
        document.getElementById('has-ethereum').textContent = 'YES âœ“';
        log('window.ethereum detected', 'success');
        
        // Detect provider
        let providerName = 'Unknown';
        if (window.ethereum.isMetaMask) providerName = 'MetaMask';
        else if (window.ethereum.isCoinbaseWallet) providerName = 'Coinbase Wallet';
        else if (window.ethereum.isRabby) providerName = 'Rabby';
        else if (window.ethereum.isBraveWallet) providerName = 'Brave Wallet';
        else if (window.ethereum.isTrust) providerName = 'Trust Wallet';
        
        document.getElementById('provider-name').textContent = providerName;
        updateDot('dot-provider', 'green');
        log('Provider: ' + providerName, 'success');
        
        // Get chain ID
        try {
          const chainId = await window.ethereum.request({ method: 'eth_chainId' });
          const chainInt = parseInt(chainId, 16);
          const chainNames = {
            1: 'Ethereum Mainnet',
            8453: 'Base',
            84532: 'Base Sepolia',
            137: 'Polygon',
            42161: 'Arbitrum'
          };
          document.getElementById('chain-id').textContent = chainInt + ' (' + (chainNames[chainInt] || 'Unknown') + ')';
          updateDot('dot-chain', chainInt === 8453 ? 'green' : 'yellow');
          log('Chain ID: ' + chainInt, chainInt === 8453 ? 'success' : 'info');
          if (chainInt !== 8453) {
            log('âš ï¸ Not on Base (8453). TheBotique uses Base for USDC payments.', 'error');
          }
        } catch (e) {
          log('Failed to get chain ID: ' + e.message, 'error');
        }
        
        // Check if already connected
        try {
          const accounts = await window.ethereum.request({ method: 'eth_accounts' });
          if (accounts.length > 0) {
            showConnected(accounts[0]);
            log('Already connected: ' + accounts[0], 'success');
          }
        } catch (e) {
          log('Failed to check existing connection: ' + e.message, 'error');
        }
        
      } else {
        updateDot('dot-ethereum', 'red');
        document.getElementById('has-ethereum').textContent = 'NO âœ—';
        log('No wallet detected! Install MetaMask or use a Web3 browser.', 'error');
      }
    });

    function showConnected(address) {
      updateDot('dot-connected', 'green');
      document.getElementById('connection-status').textContent = 'CONNECTED';
      document.getElementById('wallet-address').textContent = address;
      document.getElementById('address-display').style.display = 'block';
      document.getElementById('connect-btn').textContent = 'Connected âœ“';
      document.getElementById('connect-btn').disabled = true;
    }

    async function testConnect() {
      const btn = document.getElementById('connect-btn');
      btn.textContent = 'Connecting...';
      btn.disabled = true;
      
      log('Requesting wallet connection...');
      
      try {
        if (!window.ethereum) {
          throw new Error('No wallet provider found');
        }
        
        const accounts = await window.ethereum.request({ 
          method: 'eth_requestAccounts' 
        });
        
        if (accounts.length > 0) {
          showConnected(accounts[0]);
          log('Connected successfully!', 'success');
          log('Address: ' + accounts[0], 'success');
          
          // Get balance
          try {
            const balance = await window.ethereum.request({
              method: 'eth_getBalance',
              params: [accounts[0], 'latest']
            });
            const ethBalance = parseInt(balance, 16) / 1e18;
            log('ETH Balance: ' + ethBalance.toFixed(4) + ' ETH', 'info');
          } catch (e) {
            log('Could not fetch balance: ' + e.message, 'error');
          }
        }
      } catch (error) {
        log('Connection failed: ' + error.message, 'error');
        if (error.code === 4001) {
          log('User rejected the connection request', 'error');
        } else if (error.code === -32002) {
          log('Connection request already pending - check your wallet', 'error');
        }
        btn.textContent = 'Connect Wallet';
        btn.disabled = false;
      }
    }

    // Listen for account changes
    if (window.ethereum) {
      window.ethereum.on('accountsChanged', (accounts) => {
        log('Account changed: ' + (accounts[0] || 'disconnected'), 'info');
        if (accounts.length > 0) {
          showConnected(accounts[0]);
        } else {
          location.reload();
        }
      });
      
      window.ethereum.on('chainChanged', (chainId) => {
        log('Chain changed to: ' + parseInt(chainId, 16), 'info');
        location.reload();
      });
    }
  </script>
</body>
</html>
