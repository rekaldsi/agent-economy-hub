# Phase 10 Plan 1: Database Seeding & Initial Data

<objective>
Create an idempotent database seeding script that populates the database with the MrMagoochi agent and all 22 skills from services.js. This provides the initial data needed for launch and serves as a reference implementation for other agents.
</objective>

<execution_context>
## What We're Building

**Core Feature**: Database seeding script for initial agent and skills

**Current State** (from Phase 9):
- ✅ Database schema fully defined and initialized
- ✅ All CRUD functions available in src/db.js
- ✅ 22 services defined in src/services.js
- ✅ MrMagoochi wallet address: `0xA193128362e6dE28E6D51eEbc98505672FFeb3c5`
- ❌ NO data in database (empty agents, skills tables)
- ❌ NO seed script
- ❌ Cannot test end-to-end flow without agent/skills in system

**Services to Seed** (22 total):
- **Creative** (5): brainstorm, concept, write, brief, social_strategy
- **Research** (5): research, competitive, trends, sentiment, data_analysis
- **Technical** (3): code_review, api_help, scrape
- **Documents** (3): summarize, document, report
- **Productivity** (1): email_triage
- **Visual** (5): image_generate, image_portrait, image_logo, image_product, image_style

**Why This Matters**:
- Cannot test payment flow without real agent/skills in database
- Provides reference implementation for other agents
- Enables immediate testing after deployment
- Demonstrates full marketplace functionality

**Target State**:
- MrMagoochi user created (type: 'agent')
- MrMagoochi agent profile created (with webhook_url, api_key)
- All 22 skills seeded from services.js
- Seed script is idempotent (safe to run multiple times)
- npm run seed command available
</execution_context>

<context>
## Project Context

**Database Schema** (from src/db.js):

**users table**:
- id (serial primary key)
- wallet_address (varchar(42) unique)
- user_type (varchar(10): 'human' or 'agent')
- name (varchar(100))
- created_at, updated_at

**agents table**:
- id (serial primary key)
- user_id (foreign key to users)
- webhook_url (text, nullable)
- api_key (varchar(64) unique, auto-generated)
- is_active (boolean, default true)
- total_jobs, total_earned, rating

**skills table**:
- id (serial primary key)
- agent_id (foreign key to agents)
- name (varchar(100))
- description (text)
- category (varchar(50))
- price_usdc (decimal(18,6))
- estimated_time (varchar(50))
- service_key (text) - maps to services.js keys
- is_active (boolean, default true)

**Available DB Functions** (from src/db.js):
```javascript
createUser(walletAddress, userType, name)
getUser(walletAddress)
createAgent(userId, webhookUrl)
getAgent(userId)
getAgentByWallet(walletAddress)
createSkill(agentId, name, description, category, priceUsdc, estimatedTime)
getSkillsByAgent(agentId)
```

**MrMagoochi Details**:
- Name: "MrMagoochi"
- Wallet: `0xA193128362e6dE28E6D51eEbc98505672FFeb3c5` (Base network)
- Type: agent
- Webhook URL: null (hub processes directly, no external webhook)
- Services: All 22 from services.js

**Idempotency Requirements**:
- Check if user exists before creating
- Check if agent exists before creating
- Check if skills exist before creating
- Skip existing records (don't error, don't duplicate)
- Log what was created vs skipped
- Safe to run multiple times

**Script Location**: `scripts/seed.js` (directory already exists)

## Recent Work (Phases 1-9)

**Phase 9**: Rate Limiting & Basic Ops
- Added structured logging with Winston
- Can use logger in seed script
- Database pool and functions ready to use

**Phase 7**: Input Validation & Error Handling
- Database functions validated and secure
- Safe to use for seeding

**Phase 1**: Environment Setup
- Database connection established
- Can connect to DATABASE_URL from .env

**Unblocked By Phase 9**:
- Logger available for seed script output
- Database pool management stable
- Ready to populate initial data
</context>

---

## Tasks

## Task 1: Create Idempotent Seed Script Structure

**Goal**: Create scripts/seed.js with connection handling and idempotency checks

**What to do**:

1. **Create scripts/seed.js** with basic structure:
   ```javascript
   require('dotenv').config();
   const db = require('../src/db');
   const { getAllServices } = require('../src/services');
   const logger = require('../src/logger');

   // MrMagoochi configuration
   const MRMAGOOCHI_WALLET = '0xA193128362e6dE28E6D51eEbc98505672FFeb3c5';
   const MRMAGOOCHI_NAME = 'MrMagoochi';

   /**
    * Main seeding function
    */
   async function seed() {
     try {
       logger.info('Starting database seed...');

       // Task 2 will add user seeding here
       // Task 3 will add agent seeding here
       // Task 4 will add skills seeding here

       logger.info('Database seed complete!');
     } catch (error) {
       logger.error('Seed failed', { error: error.message, stack: error.stack });
       throw error;
     } finally {
       // Close database connection
       await db.closePool();
     }
   }

   // Run if called directly
   if (require.main === module) {
     seed()
       .then(() => {
         logger.info('Seed script finished successfully');
         process.exit(0);
       })
       .catch((error) => {
         logger.error('Seed script failed', { error: error.message });
         process.exit(1);
       });
   }

   module.exports = { seed };
   ```

2. **Verify structure**:
   ```bash
   node scripts/seed.js
   ```
   Should log "Starting database seed..." and "Database seed complete!" then exit

**Files Modified**:
- `scripts/seed.js` (created - ~45 lines)

**Verification**:
- Script runs without errors
- Logs appear with timestamps (Winston)
- Database pool closes cleanly
- Script exits with code 0

**Commit Message**:
```
chore(10-01): create idempotent seed script structure
```

---

## Task 2: Seed MrMagoochi User

**Goal**: Create MrMagoochi user record with idempotency check

**What to do**:

1. **Add user seeding logic** in scripts/seed.js (in the seed() function):
   ```javascript
   // 1. Create or get MrMagoochi user
   logger.info('Checking for MrMagoochi user...');
   let user = await db.getUser(MRMAGOOCHI_WALLET);

   if (user) {
     logger.info('MrMagoochi user already exists', {
       userId: user.id,
       wallet: user.wallet_address,
       name: user.name
     });
   } else {
     logger.info('Creating MrMagoochi user...');
     user = await db.createUser(MRMAGOOCHI_WALLET, 'agent', MRMAGOOCHI_NAME);
     logger.info('MrMagoochi user created', {
       userId: user.id,
       wallet: user.wallet_address,
       name: user.name
     });
   }
   ```

2. **Test user creation**:
   ```bash
   node scripts/seed.js
   ```
   Expected:
   - First run: "Creating MrMagoochi user..." → "MrMagoochi user created"
   - Second run: "MrMagoochi user already exists" (idempotent)

**Files Modified**:
- `scripts/seed.js` (add user seeding logic)

**Verification**:
- User created in database
- wallet_address: `0xA193128362e6dE28E6D51eEbc98505672FFeb3c5`
- user_type: 'agent'
- name: 'MrMagoochi'
- Second run doesn't create duplicate (idempotent)

**Commit Message**:
```
feat(10-01): seed MrMagoochi user with idempotency check
```

---

## Task 3: Seed MrMagoochi Agent Profile

**Goal**: Create MrMagoochi agent profile with webhook_url and api_key

**What to do**:

1. **Add agent seeding logic** in scripts/seed.js (after user seeding):
   ```javascript
   // 2. Create or get MrMagoochi agent
   logger.info('Checking for MrMagoochi agent...');
   let agent = await db.getAgent(user.id);

   if (agent) {
     logger.info('MrMagoochi agent already exists', {
       agentId: agent.id,
       userId: agent.user_id,
       apiKey: agent.api_key ? `${agent.api_key.substring(0, 10)}...` : null,
       webhookUrl: agent.webhook_url || 'none (hub processes directly)'
     });
   } else {
     logger.info('Creating MrMagoochi agent...');
     // webhook_url = null means hub processes jobs directly (no external webhook)
     agent = await db.createAgent(user.id, null);
     logger.info('MrMagoochi agent created', {
       agentId: agent.id,
       userId: agent.user_id,
       apiKey: agent.api_key ? `${agent.api_key.substring(0, 10)}...` : null,
       webhookUrl: 'none (hub processes directly)'
     });
   }
   ```

2. **Test agent creation**:
   ```bash
   node scripts/seed.js
   ```
   Expected:
   - First run: Creates user and agent
   - Second run: Skips both (idempotent)
   - Agent has api_key (auto-generated by createAgent)
   - Agent has webhook_url = null

**Files Modified**:
- `scripts/seed.js` (add agent seeding logic)

**Verification**:
- Agent created in database
- user_id links to MrMagoochi user
- api_key auto-generated (starts with 'hub_')
- webhook_url is null
- is_active is true
- Second run doesn't create duplicate

**Commit Message**:
```
feat(10-01): seed MrMagoochi agent profile with API key
```

---

## Task 4: Seed All 22 Skills from services.js

**Goal**: Create all 22 skills from services.js with idempotency check

**What to do**:

1. **Add skills seeding logic** in scripts/seed.js (after agent seeding):
   ```javascript
   // 3. Create or update skills from services.js
   logger.info('Seeding skills from services.js...');
   const services = getAllServices();
   logger.info(`Found ${services.length} services to seed`);

   // Get existing skills for this agent
   const existingSkills = await db.getSkillsByAgent(agent.id);
   const existingServiceKeys = new Set(existingSkills.map(s => s.service_key));

   let created = 0;
   let skipped = 0;

   for (const service of services) {
     if (existingServiceKeys.has(service.key)) {
       logger.info(`Skill already exists: ${service.key}`, {
         name: service.name,
         category: service.category,
         price: service.price
       });
       skipped++;
     } else {
       logger.info(`Creating skill: ${service.key}`, {
         name: service.name,
         category: service.category,
         price: service.price
       });

       const skill = await db.createSkill(
         agent.id,
         service.name,
         service.description,
         service.category,
         service.price,
         service.estimatedTime
       );

       // Update service_key for mapping
       await db.query(
         'UPDATE skills SET service_key = $1 WHERE id = $2',
         [service.key, skill.id]
       );

       created++;
     }
   }

   logger.info('Skills seeding complete', {
     total: services.length,
     created,
     skipped,
     categories: {
       creative: services.filter(s => s.category === 'creative').length,
       research: services.filter(s => s.category === 'research').length,
       technical: services.filter(s => s.category === 'technical').length,
       documents: services.filter(s => s.category === 'documents').length,
       productivity: services.filter(s => s.category === 'productivity').length,
       visual: services.filter(s => s.category === 'visual').length
     }
   });
   ```

2. **Test skills creation**:
   ```bash
   node scripts/seed.js
   ```
   Expected:
   - First run: Creates 22 skills
   - Second run: Skips all 22 (idempotent)
   - Logs show categories breakdown

3. **Verify in database** (optional manual check):
   ```bash
   psql $DATABASE_URL -c "SELECT COUNT(*) as skill_count FROM skills;"
   psql $DATABASE_URL -c "SELECT category, COUNT(*) FROM skills GROUP BY category;"
   ```
   Expected: 22 total skills across 6 categories

**Files Modified**:
- `scripts/seed.js` (add skills seeding logic)

**Verification**:
- All 22 skills created in database
- Each skill has:
  - agent_id linking to MrMagoochi
  - name, description, category from services.js
  - price_usdc from services.js
  - estimated_time from services.js
  - service_key matching services.js key
  - is_active = true
- Categories: creative (5), research (5), technical (3), documents (3), productivity (1), visual (5)
- Second run doesn't create duplicates
- Logs show created vs skipped counts

**Commit Message**:
```
feat(10-01): seed all 22 skills from services.js
```

---

## Task 5: Add npm Seed Script and Documentation

**Goal**: Add convenient npm command and document usage

**What to do**:

1. **Add seed script to package.json**:
   ```json
   {
     "scripts": {
       "start": "node src/index.js",
       "dev": "node --watch src/index.js",
       "seed": "node scripts/seed.js"
     }
   }
   ```

2. **Test npm script**:
   ```bash
   npm run seed
   ```
   Expected: Same output as `node scripts/seed.js`

3. **Create seed documentation** `scripts/README.md`:
   ```markdown
   # Scripts

   ## Database Seeding

   ### seed.js

   Seeds the database with initial data for the Agent Economy Hub.

   **What it seeds**:
   - MrMagoochi user (agent type)
   - MrMagoochi agent profile (with API key)
   - 22 skills from services.js

   **Usage**:
   ```bash
   npm run seed
   ```

   Or directly:
   ```bash
   node scripts/seed.js
   ```

   **Idempotency**:
   The script is safe to run multiple times. It will:
   - Skip existing users, agents, and skills
   - Only create missing records
   - Log what was created vs skipped

   **Requirements**:
   - DATABASE_URL must be set in .env
   - Database schema must be initialized (runs automatically on server start)

   **Output**:
   Structured JSON logs showing:
   - User creation/skip status
   - Agent creation/skip status
   - Skills creation/skip counts by category
   - Any errors encountered

   **After Seeding**:
   You can verify the data:
   ```bash
   # Check users
   psql $DATABASE_URL -c "SELECT * FROM users WHERE user_type='agent';"

   # Check agents
   psql $DATABASE_URL -c "SELECT * FROM agents;"

   # Check skills count
   psql $DATABASE_URL -c "SELECT category, COUNT(*) FROM skills GROUP BY category;"
   ```
   ```

**Files Modified**:
- `package.json` (add "seed" script)
- `scripts/README.md` (created - ~50 lines)

**Verification**:
- `npm run seed` works
- Documentation is clear and helpful
- Includes usage examples and verification commands

**Commit Message**:
```
docs(10-01): add npm seed script and documentation
```

---

## Task 6: Verify Seed Data and Test End-to-End

**Goal**: Verify seeded data is correct and test full flow

**What to do**:

1. **Run seed script fresh** (reset database first if needed):
   ```bash
   # Clear existing data (optional, for clean test)
   psql $DATABASE_URL -c "TRUNCATE users CASCADE;"

   # Run seed
   npm run seed
   ```

2. **Verify user**:
   ```bash
   psql $DATABASE_URL -c "SELECT id, wallet_address, user_type, name FROM users WHERE user_type='agent';"
   ```
   Expected: 1 row with MrMagoochi data

3. **Verify agent**:
   ```bash
   psql $DATABASE_URL -c "SELECT id, user_id, webhook_url, is_active, LEFT(api_key, 10) as api_key_preview FROM agents;"
   ```
   Expected: 1 row with MrMagoochi agent, webhook_url=null, api_key starts with 'hub_'

4. **Verify skills**:
   ```bash
   psql $DATABASE_URL -c "SELECT category, COUNT(*) as count FROM skills GROUP BY category ORDER BY category;"
   ```
   Expected:
   - creative: 5
   - documents: 3
   - productivity: 1
   - research: 5
   - technical: 3
   - visual: 5
   - **Total: 22**

5. **Verify service_key mapping**:
   ```bash
   psql $DATABASE_URL -c "SELECT service_key, name, category, price_usdc FROM skills LIMIT 5;"
   ```
   Expected: service_key values like 'brainstorm', 'concept', matching services.js

6. **Test idempotency** (run seed again):
   ```bash
   npm run seed
   ```
   Expected:
   - Logs show "already exists" for user, agent
   - Logs show "skipped: 22" for skills
   - No new records created
   - Exit code 0

7. **Test web UI** (optional, for visual verification):
   ```bash
   npm start
   ```
   Then visit:
   - http://localhost:7378/agents - Should show MrMagoochi
   - http://localhost:7378/agent/1 - Should show MrMagoochi with 22 skills

**Files Modified**:
- None (verification only)

**Verification**:
- ✅ 1 agent user created (MrMagoochi)
- ✅ 1 agent profile created (with API key)
- ✅ 22 skills created (all categories present)
- ✅ service_key maps correctly to services.js
- ✅ Idempotency works (second run skips everything)
- ✅ MrMagoochi appears in /agents UI
- ✅ Skills appear in /agent/1 UI

**Commit Message**:
```
test(10-01): verify seed data and idempotency
```

---

## Verification

**After All Tasks Complete**:

1. **Database populated**:
   ```sql
   SELECT 'users' as table, COUNT(*) as count FROM users WHERE user_type='agent'
   UNION ALL
   SELECT 'agents', COUNT(*) FROM agents
   UNION ALL
   SELECT 'skills', COUNT(*) FROM skills;
   ```
   Expected:
   - users: 1
   - agents: 1
   - skills: 22

2. **Skills by category**:
   ```sql
   SELECT category, COUNT(*) FROM skills GROUP BY category ORDER BY category;
   ```
   Expected:
   - creative: 5
   - documents: 3
   - productivity: 1
   - research: 5
   - technical: 3
   - visual: 5

3. **Idempotency test**:
   ```bash
   npm run seed
   npm run seed
   npm run seed
   ```
   All three runs should:
   - Exit with code 0
   - Skip all existing records
   - Show consistent logs

4. **npm script works**:
   ```bash
   npm run seed
   ```
   Executes without errors

5. **Documentation exists**:
   ```bash
   cat scripts/README.md
   ```
   Shows usage instructions

**Success Criteria**:
- ✅ MrMagoochi user created (type: agent)
- ✅ MrMagoochi agent created (with API key, webhook_url=null)
- ✅ All 22 skills seeded from services.js
- ✅ service_key field populated for all skills
- ✅ Script is idempotent (safe to run multiple times)
- ✅ npm run seed command works
- ✅ Documentation created (scripts/README.md)
- ✅ Structured logging throughout
- ✅ Database pool closes cleanly

---

## Success Criteria

- [ ] scripts/seed.js created with idempotent logic
- [ ] MrMagoochi user created (wallet: 0xA193...3c5, type: agent)
- [ ] MrMagoochi agent created (webhook_url: null, api_key: generated)
- [ ] All 22 skills seeded from services.js
- [ ] Skills mapped to services.js via service_key field
- [ ] Script skips existing records (idempotent)
- [ ] npm run seed command added to package.json
- [ ] scripts/README.md documentation created
- [ ] All changes committed with proper commit messages
- [ ] Verified data in database (1 agent, 22 skills)
- [ ] Tested idempotency (multiple runs produce same result)

---

## Output

**Files Created**:
- `scripts/seed.js` (~130 lines) - Idempotent database seeding script
- `scripts/README.md` (~50 lines) - Seed script documentation

**Files Modified**:
- `package.json` - Added "seed" script

**Database Records Created**:
- 1 user (MrMagoochi, type: agent)
- 1 agent (MrMagoochi profile with API key)
- 22 skills (all services from services.js)

**Total Lines Added**: ~180 lines (script + documentation)

**API Changes**: None (database only)

**Estimated Complexity**: Low (database script, straightforward logic)

**Estimated Time**: ~45 minutes

---

*Plan created: 2026-02-03 for Phase 10: Database Seeding & Initial Data*
