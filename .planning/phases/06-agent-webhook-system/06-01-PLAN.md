# Phase 6 Plan 1: Agent Webhook System

<objective>
Enable external agent notifications via HTTP webhooks when jobs are paid. Build webhook delivery service with retry logic, timeout handling, and add endpoint for agents to complete jobs. This enables the multi-agent marketplace where external agents can process jobs independently.
</objective>

<execution_context>
## What We're Building

**Core Feature**: Agent webhook notification system for job processing

**Current State** (from Phase 5):
- ✅ Payment flow complete: users pay → job status = 'paid'
- ✅ Hub processes jobs itself (generateWithAI, generateImage)
- ✅ Results stored in jobs.output_data
- ❌ No webhook notification to external agents
- ❌ External agents can't notify hub when jobs complete
- ❌ Hub processes ALL jobs itself (not scalable)

**Current Flow**:
```
User pays → Hub verifies payment → Hub processes job → Hub stores result → Job complete
```

**Target Flow**:
```
User pays → Hub verifies payment → Hub notifies agent via webhook → Agent processes job → Agent posts result back → Job complete
```

**Why This Matters**: The hub currently processes all jobs itself. For a marketplace to scale, external agents need to:
1. Be notified when jobs are paid (webhook POST)
2. Process jobs on their own infrastructure
3. Return results to the hub (POST /api/jobs/:uuid/complete)

**Database Context**:
- Agents table has `webhook_url` field (TEXT, can be NULL)
- If agent.webhook_url exists → notify webhook
- If agent.webhook_url is NULL → hub processes job itself (current behavior)

**Success**: External agents can receive job notifications and return results
</execution_context>

<context>
## Project Context

**Tech Stack**:
- Backend: Node.js + Express
- HTTP Client: axios (already installed in package.json)
- Database: PostgreSQL via pg
- Current processing: In-memory (src/ai.js, src/replicate.js)

**Webhook Payload Format** (design):
```javascript
POST agent.webhook_url
{
  "jobUuid": "abc-123",
  "agentId": 1,
  "skillId": 5,
  "serviceKey": "brainstorm",
  "input": { "prompt": "..." },
  "price": 0.50,
  "paidAt": "2026-02-03T19:00:00Z"
}
```

**Agent Response Format** (expected):
```javascript
POST /api/jobs/:uuid/complete
{
  "apiKey": "agent-api-key-here",
  "output": {
    "ideas": [...],  // or images: [...], etc.
    // whatever format the service requires
  }
}
```

**Key Files**:
- `src/hub.js:1821-2007` — POST /api/jobs/:uuid/pay (payment endpoint)
- `src/hub.js:1879-1959` — AI processing logic (currently synchronous)
- `src/db.js:29-30` — agents.webhook_url, agents.api_key fields
- `package.json` — axios already available

**Retry Strategy**:
- Attempt 1: Immediate
- Attempt 2: 1s delay
- Attempt 3: 2s delay
- Attempt 4: 4s delay
- After 4 attempts: Mark job as 'failed', log to database

**Timeout Strategy**:
- 30s per HTTP request
- Total max webhook time: ~45s (4 attempts + delays)

## Recent Work (Phases 1-5)

**Phase 1**: Environment setup
**Phase 2**: Payment verification, security
**Phase 3**: Payment → AI text generation flow
**Phase 4**: Replicate image generation (✅ complete)
**Phase 5**: Results display formatting (✅ complete)

**Phase 3 Created**:
- AI processing happens in payment endpoint (src/hub.js:1879-1959)
- Synchronous: payment verified → immediate processing → result stored
- All processing done by hub itself

**Unblocked By Phase 5**:
- Have rich result display (can show webhook results same as direct results)
- Job detail page ready for any output format
- Status indicators ready (paid, completed, failed)

## Success Criteria

### Functional
- [ ] External agents notified via POST to webhook_url when job paid
- [ ] Webhook payload includes all job details
- [ ] Retry logic (4 attempts with exponential backoff)
- [ ] Timeout handling (30s per HTTP request)
- [ ] POST /api/jobs/:uuid/complete endpoint for agent responses
- [ ] API key authentication for agent responses
- [ ] Job status tracking (paid → delivered → completed)

### User Experience
- [ ] Hub processes jobs for agents WITHOUT webhook_url (backward compatible)
- [ ] Hub notifies webhooks for agents WITH webhook_url (new behavior)
- [ ] Jobs complete successfully via either path
- [ ] Clear error messages when webhooks fail
- [ ] Failed webhook jobs marked as 'failed' with error details

### Technical
- [ ] No breaking changes to existing payment flow
- [ ] Webhook delivery async (doesn't block payment response)
- [ ] Database tracks webhook attempts and failures
- [ ] Logs include webhook URLs, responses, errors
</context>

<tasks>

## Task 1: Create Webhook Service Module

**Objective**: Build webhook delivery service with retry logic and timeout handling

**Why First**: Centralize webhook logic, make it testable and reusable

**Implementation**:

**File**: Create `src/webhooks.js` (new file)

**Code to Add**:
```javascript
const axios = require('axios');

/**
 * Deliver webhook with retry logic
 * @param {string} webhookUrl - Agent's webhook URL
 * @param {Object} payload - Webhook payload
 * @param {Object} options - { maxAttempts, timeoutMs, retryDelays }
 * @returns {Promise<Object>} { success: boolean, attempts: number, response?, error? }
 */
async function deliverWebhook(webhookUrl, payload, options = {}) {
  const {
    maxAttempts = 4,
    timeoutMs = 30000,
    retryDelays = [0, 1000, 2000, 4000] // Exponential backoff: 0s, 1s, 2s, 4s
  } = options;

  let lastError = null;

  for (let attempt = 1; attempt <= maxAttempts; attempt++) {
    try {
      console.log(JSON.stringify({
        event: 'webhook_attempt',
        attempt,
        webhookUrl,
        jobUuid: payload.jobUuid,
        timestamp: new Date().toISOString()
      }));

      // Wait for retry delay (0 on first attempt)
      const delay = retryDelays[attempt - 1] || 0;
      if (delay > 0) {
        await new Promise(resolve => setTimeout(resolve, delay));
      }

      // Make HTTP POST with timeout
      const response = await axios.post(webhookUrl, payload, {
        timeout: timeoutMs,
        headers: {
          'Content-Type': 'application/json',
          'User-Agent': 'AgentEconomyHub/1.0'
        },
        validateStatus: (status) => status >= 200 && status < 300
      });

      // Success!
      console.log(JSON.stringify({
        event: 'webhook_success',
        attempt,
        webhookUrl,
        jobUuid: payload.jobUuid,
        statusCode: response.status,
        timestamp: new Date().toISOString()
      }));

      return {
        success: true,
        attempts: attempt,
        statusCode: response.status,
        response: response.data
      };

    } catch (error) {
      lastError = error;

      console.error(JSON.stringify({
        event: 'webhook_failure',
        attempt,
        webhookUrl,
        jobUuid: payload.jobUuid,
        error: error.message,
        code: error.code,
        statusCode: error.response?.status,
        timestamp: new Date().toISOString()
      }));

      // Don't retry on 4xx errors (client errors)
      if (error.response && error.response.status >= 400 && error.response.status < 500) {
        console.log(JSON.stringify({
          event: 'webhook_abort',
          reason: '4xx_error',
          statusCode: error.response.status,
          jobUuid: payload.jobUuid
        }));

        return {
          success: false,
          attempts: attempt,
          statusCode: error.response.status,
          error: `HTTP ${error.response.status}: ${error.message}`
        };
      }

      // Continue retrying on 5xx or network errors
    }
  }

  // All attempts failed
  console.error(JSON.stringify({
    event: 'webhook_exhausted',
    webhookUrl,
    jobUuid: payload.jobUuid,
    attempts: maxAttempts,
    error: lastError?.message
  }));

  return {
    success: false,
    attempts: maxAttempts,
    error: lastError?.message || 'All webhook attempts failed'
  };
}

/**
 * Notify agent of paid job via webhook
 * @param {Object} job - Job object from database
 * @param {Object} skill - Skill object from database
 * @param {Object} agent - Agent object from database
 */
async function notifyAgent(job, skill, agent) {
  if (!agent.webhook_url) {
    console.log(JSON.stringify({
      event: 'webhook_skip',
      reason: 'no_webhook_url',
      agentId: agent.id,
      jobUuid: job.job_uuid
    }));
    return { success: false, skipped: true, reason: 'no_webhook_url' };
  }

  const payload = {
    jobUuid: job.job_uuid,
    agentId: agent.id,
    skillId: skill.id,
    serviceKey: skill.service_key,
    input: job.input_data,
    price: parseFloat(job.price_usdc),
    paidAt: job.paid_at || new Date().toISOString()
  };

  const result = await deliverWebhook(agent.webhook_url, payload);

  return result;
}

module.exports = {
  deliverWebhook,
  notifyAgent
};
```

**Verification**:
- Functions compile without errors
- No dependencies on other modules (pure axios)

**Deliverable**:
- src/webhooks.js created with deliverWebhook() and notifyAgent()
- Retry logic with exponential backoff
- Timeout handling (30s)
- Structured logging for all webhook events

**Commit**: `feat(06-01): create webhook delivery service with retry logic`

---

## Task 2: Integrate Webhooks into Payment Endpoint

**Objective**: Call webhook after payment verification, before or instead of processing

**Why Second**: Wire webhooks into actual payment flow

**Implementation**:

**File**: `src/hub.js`

**Location**: Payment endpoint (line 1821-2007)

**Add Import** (top of file):
```javascript
const { notifyAgent } = require('./webhooks');
```

**Current Flow** (line 1873-1877):
```javascript
// Update job status to paid
await db.updateJobStatus(job.id, 'paid', {
  payment_tx_hash: txHash,
  paid_at: new Date()
});
```

**After this**, add webhook logic:

```javascript
// Update job status to paid
await db.updateJobStatus(job.id, 'paid', {
  payment_tx_hash: txHash,
  paid_at: new Date()
});

// Get skill to check if webhook needed
const skill = await db.getSkill(job.skill_id);
if (!skill || !skill.service_key) {
  throw new Error('Skill or service_key not found');
}

// Check if agent has webhook configured
if (agent.webhook_url) {
  // WEBHOOK PATH: Notify external agent
  console.log(JSON.stringify({
    event: 'webhook_path',
    jobUuid: job.job_uuid,
    webhookUrl: agent.webhook_url,
    timestamp: new Date().toISOString()
  }));

  // Notify agent asynchronously (don't await - fire and forget)
  notifyAgent(job, skill, agent).then(webhookResult => {
    if (!webhookResult.success && !webhookResult.skipped) {
      // Webhook failed after all retries - mark job as failed
      db.updateJobStatus(job.id, 'failed', {
        output_data: JSON.stringify({
          error: 'Webhook delivery failed',
          details: webhookResult.error
        })
      }).catch(err => console.error('Failed to update job status:', err));
    }
  }).catch(err => {
    console.error('Webhook notification error:', err);
  });

  // Return immediately - agent will process job and call back
  return res.json({
    success: true,
    jobUuid: job.job_uuid,
    status: 'paid',
    txHash,
    verified: true,
    amount: verification.amount,
    blockNumber: verification.blockNumber,
    webhookNotified: true,
    message: 'Agent notified via webhook. Job will be processed asynchronously.'
  });
}

// NO WEBHOOK PATH: Hub processes job itself (EXISTING BEHAVIOR)
console.log(JSON.stringify({
  event: 'hub_processing_path',
  jobUuid: job.job_uuid,
  reason: 'no_webhook_url',
  timestamp: new Date().toISOString()
}));

// AI/Image Processing - Generate output using the agent's service
const processingStartTime = Date.now();
// ... rest of existing processing code continues unchanged ...
```

**Important Notes**:
- Webhook path: Notify agent, return immediately, don't process
- No webhook path: Hub processes job itself (existing behavior from Phase 3/4)
- Webhook failures update job to 'failed' status
- Already have `agent` object from line 1840

**Verification**:
- Payment endpoint still works for agents without webhook_url
- Payment endpoint notifies webhook for agents with webhook_url
- Webhook notifications don't block payment response

**Deliverable**:
- Webhooks integrated into payment flow
- Conditional logic: webhook vs hub processing
- Backward compatible with existing agents

**Commit**: `feat(06-01): integrate webhook notifications into payment flow`

---

## Task 3: Create Agent Job Completion Endpoint

**Objective**: Allow external agents to POST job results back to hub

**Why Third**: Complete the webhook loop - agents need a way to return results

**Implementation**:

**File**: `src/hub.js`

**Location**: After GET /api/jobs/:uuid (around line 2010-2020)

**Code to Add**:
```javascript
// Agent completes job (webhook callback)
router.post('/api/jobs/:uuid/complete', async (req, res) => {
  try {
    const { apiKey, output } = req.body;

    // Validate API key
    if (!apiKey || typeof apiKey !== 'string') {
      return res.status(401).json({ error: 'API key required' });
    }

    // Validate output
    if (!output || typeof output !== 'object') {
      return res.status(400).json({ error: 'Output data required' });
    }

    // Get job
    const job = await db.getJob(req.params.uuid);
    if (!job) {
      return res.status(404).json({ error: 'Job not found' });
    }

    // Get agent and verify API key
    const agent = await db.getAgent(job.agent_id);
    if (!agent) {
      return res.status(500).json({ error: 'Agent not found' });
    }

    if (agent.api_key !== apiKey) {
      console.error(JSON.stringify({
        event: 'unauthorized_completion',
        jobUuid: job.job_uuid,
        agentId: agent.id,
        providedKey: apiKey.substring(0, 8) + '...'
      }));
      return res.status(403).json({ error: 'Invalid API key' });
    }

    // Check job status (must be 'paid' or 'in_progress')
    if (!['paid', 'in_progress'].includes(job.status)) {
      return res.status(400).json({
        error: `Job status is ${job.status}, cannot complete`
      });
    }

    console.log(JSON.stringify({
      event: 'agent_completion',
      jobUuid: job.job_uuid,
      agentId: agent.id,
      status: job.status,
      timestamp: new Date().toISOString()
    }));

    // Update job with agent's output
    await db.updateJobStatus(job.id, 'completed', {
      output_data: JSON.stringify(output),
      completed_at: new Date()
    });

    // Update agent stats (total_jobs, total_earned)
    await db.query(
      'UPDATE agents SET total_jobs = total_jobs + 1, total_earned = total_earned + $1 WHERE id = $2',
      [job.price_usdc, agent.id]
    );

    res.json({
      success: true,
      jobUuid: job.job_uuid,
      status: 'completed',
      message: 'Job completed successfully'
    });

  } catch (error) {
    console.error('Job completion error:', error);
    res.status(500).json({ error: error.message });
  }
});
```

**API Documentation** (add to comments):
```
POST /api/jobs/:uuid/complete

Headers:
  Content-Type: application/json

Body:
  {
    "apiKey": "agent-api-key-here",
    "output": {
      // Service-specific output format
      // Text services: { ideas: [...], summary: "...", etc. }
      // Image services: { images: ["url1", "url2"] }
    }
  }

Response (200):
  {
    "success": true,
    "jobUuid": "abc-123",
    "status": "completed",
    "message": "Job completed successfully"
  }

Errors:
  401 - Missing or invalid API key
  403 - API key doesn't match agent
  404 - Job not found
  400 - Invalid job status or missing output
```

**Verification**:
- Endpoint requires valid API key
- Endpoint validates job status
- Endpoint updates job to 'completed'
- Endpoint updates agent stats

**Deliverable**:
- POST /api/jobs/:uuid/complete endpoint created
- API key authentication
- Job completion logic
- Agent stats tracking

**Commit**: `feat(06-01): add agent job completion endpoint`

---

## Task 4: Add Database Schema for Webhook Tracking

**Objective**: Track webhook attempts and failures in database

**Why Fourth**: Operational visibility into webhook health

**Implementation**:

**File**: `src/db.js`

**Location**: In initDB() after existing tables (around line 88)

**Add Table**:
```javascript
// Webhook delivery log
CREATE TABLE IF NOT EXISTS webhook_deliveries (
  id SERIAL PRIMARY KEY,
  job_id INTEGER REFERENCES jobs(id) ON DELETE CASCADE,
  agent_id INTEGER REFERENCES agents(id) ON DELETE CASCADE,
  webhook_url TEXT NOT NULL,
  attempts INTEGER NOT NULL,
  success BOOLEAN NOT NULL,
  status_code INTEGER,
  error TEXT,
  response_body TEXT,
  created_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_webhook_deliveries_job ON webhook_deliveries(job_id);
CREATE INDEX IF NOT EXISTS idx_webhook_deliveries_agent ON webhook_deliveries(agent_id);
CREATE INDEX IF NOT EXISTS idx_webhook_deliveries_success ON webhook_deliveries(success);
```

**Add Helper Function** (after other query helpers):
```javascript
/**
 * Log webhook delivery attempt
 */
async function logWebhookDelivery(jobId, agentId, webhookUrl, result) {
  await query(
    `INSERT INTO webhook_deliveries (job_id, agent_id, webhook_url, attempts, success, status_code, error, response_body)
     VALUES ($1, $2, $3, $4, $5, $6, $7, $8)`,
    [
      jobId,
      agentId,
      webhookUrl,
      result.attempts || 0,
      result.success || false,
      result.statusCode || null,
      result.error || null,
      result.response ? JSON.stringify(result.response) : null
    ]
  );
}

module.exports = {
  // ... existing exports ...
  logWebhookDelivery
};
```

**Update webhooks.js** to use logger:

Add to `notifyAgent()` function (at the end, before return):
```javascript
// Log delivery to database (fire and forget)
const db = require('./db');
db.logWebhookDelivery(job.id, agent.id, agent.webhook_url, result)
  .catch(err => console.error('Failed to log webhook delivery:', err));

return result;
```

**Verification**:
- Table created successfully
- Webhook attempts logged to database
- Can query webhook_deliveries for agent health

**Deliverable**:
- webhook_deliveries table created
- logWebhookDelivery() helper function
- Webhook logging integrated

**Commit**: `feat(06-01): add webhook delivery tracking to database`

---

## Task 5: Update Job Status to Support 'in_progress'

**Objective**: Add 'in_progress' status for jobs being processed by external agents

**Why Fifth**: Better status tracking for long-running agent jobs

**Implementation**:

**File**: `src/db.js`

**Location**: jobs table CHECK constraint (line 59)

**Current**:
```sql
status VARCHAR(20) DEFAULT 'pending' CHECK (status IN ('pending', 'paid', 'in_progress', 'delivered', 'completed', 'disputed', 'refunded', 'failed'))
```

**Already includes 'in_progress'!** No change needed.

**Add Helper Function** (after existing helpers):
```javascript
/**
 * Mark job as in-progress (agent is processing)
 */
async function markJobInProgress(jobId) {
  return updateJobStatus(jobId, 'in_progress', {
    // No additional fields needed
  });
}

module.exports = {
  // ... existing exports ...
  markJobInProgress
};
```

**Optional Enhancement** in POST /api/jobs/:uuid/complete:

Allow agents to mark jobs as 'in_progress' before completing:
```javascript
// Agent can optionally POST { apiKey, status: 'in_progress' } to mark job as in-progress
if (req.body.status === 'in_progress' && !req.body.output) {
  // Mark as in-progress without output
  await db.updateJobStatus(job.id, 'in_progress');
  return res.json({
    success: true,
    jobUuid: job.job_uuid,
    status: 'in_progress',
    message: 'Job marked as in-progress'
  });
}
```

**Verification**:
- Job status can be set to 'in_progress'
- Agents can mark jobs as in-progress via API

**Deliverable**:
- markJobInProgress() helper (optional, for clarity)
- Optional: Allow agents to mark jobs in-progress via API

**Commit**: `feat(06-01): support in_progress status for agent jobs`

---

## Task 6: Add Webhook Testing & Documentation

**Objective**: Document webhook behavior and add test script

**Why Sixth**: Developers need to understand webhook integration

**Implementation**:

**File**: Create `docs/WEBHOOKS.md` (new)

**Content**:
```markdown
# Webhook Integration Guide

## Overview

The Agent Economy Hub notifies external agents via HTTP webhooks when jobs are paid. Agents process jobs on their own infrastructure and return results via callback.

## Flow

1. **User pays for job** → Hub verifies payment on-chain
2. **Hub notifies agent** → POST to `agent.webhook_url` with job details
3. **Agent processes job** → Agent's own AI/service infrastructure
4. **Agent returns result** → POST to `/api/jobs/:uuid/complete` with output

## Webhook Payload

When a job is paid, the hub sends:

**POST** `agent.webhook_url`

```json
{
  "jobUuid": "abc-123-def-456",
  "agentId": 1,
  "skillId": 5,
  "serviceKey": "brainstorm",
  "input": {
    "prompt": "Generate 5 ideas for sustainable fashion marketing"
  },
  "price": 0.50,
  "paidAt": "2026-02-03T19:00:00Z"
}
```

## Agent Response Requirements

Your webhook endpoint MUST:
- Respond with HTTP 2xx within 30 seconds
- Return quickly (< 5s) - process jobs asynchronously
- Be idempotent (handle duplicate notifications)

## Completing Jobs

When processing is complete, POST results back to hub:

**POST** `https://hub.example.com/api/jobs/:uuid/complete`

**Headers**:
```
Content-Type: application/json
```

**Body**:
```json
{
  "apiKey": "your-agent-api-key",
  "output": {
    "ideas": [
      {"angle": "...", "idea": "...", "why": "..."},
      ...
    ]
  }
}
```

**Response** (200):
```json
{
  "success": true,
  "jobUuid": "abc-123",
  "status": "completed"
}
```

## Output Formats

Match the service type:

**Text Services** (brainstorm, research, write, etc.):
```json
{
  "ideas": [...],          // brainstorm
  "summary": "...",        // research
  "output": "...",         // write
  // ... service-specific fields
}
```

**Image Services** (image_generate, image_portrait, etc.):
```json
{
  "images": [
    "https://cdn.example.com/image1.png",
    "https://cdn.example.com/image2.png"
  ]
}
```

## Retry Behavior

The hub retries failed webhook deliveries:
- Attempt 1: Immediate
- Attempt 2: 1s delay
- Attempt 3: 2s delay
- Attempt 4: 4s delay

After 4 failed attempts, the job is marked as 'failed'.

## Error Handling

**4xx errors**: No retry (client error, fix webhook endpoint)
**5xx errors**: Retry with backoff (server error, transient)
**Timeout**: Retry (webhook took > 30s)

## Testing Your Webhook

Test webhook with:
```bash
curl -X POST https://your-webhook-url.com/webhook \
  -H "Content-Type: application/json" \
  -d '{
    "jobUuid": "test-123",
    "agentId": 1,
    "skillId": 1,
    "serviceKey": "brainstorm",
    "input": {"prompt": "Test prompt"},
    "price": 0.10,
    "paidAt": "2026-02-03T19:00:00Z"
  }'
```

## Security

- Use HTTPS for webhook URLs
- Validate request payloads
- Use API key authentication for callbacks
- Rate limit your webhook endpoint

## FAQ

**Q: Can I process jobs synchronously in my webhook?**
A: No. Respond within 30s, process asynchronously, then call back with results.

**Q: What if my webhook is down?**
A: Hub retries 4 times over ~7 seconds. After that, job marked as failed.

**Q: Can I update job status to 'in_progress'?**
A: Yes, POST to `/api/jobs/:uuid/complete` with `{"apiKey": "...", "status": "in_progress"}` (no output needed).

**Q: What happens if hub doesn't receive my callback?**
A: Job stays in 'paid' status indefinitely. Implement timeouts in your agent.
```

**Create Test Script** (optional): `scripts/test-webhook.js`
```javascript
// Simple webhook test server
const express = require('express');
const app = express();
app.use(express.json());

app.post('/webhook', (req, res) => {
  console.log('Webhook received:', JSON.stringify(req.body, null, 2));
  res.json({ received: true });
});

app.listen(8080, () => {
  console.log('Test webhook server: http://localhost:8080/webhook');
});
```

**Verification**:
- Documentation clear and complete
- Test script helps developers test integration

**Deliverable**:
- docs/WEBHOOKS.md created
- scripts/test-webhook.js created (optional)
- Webhook behavior fully documented

**Commit**: `docs(06-01): add webhook integration guide`

---

</tasks>

<verification>

## Pre-Execution Checklist

Before starting implementation:
- [ ] Phase 5 complete (results display working)
- [ ] Payment endpoint working (POST /api/jobs/:uuid/pay)
- [ ] Agents table has webhook_url and api_key fields
- [ ] axios installed in package.json

## Post-Task Checkpoints

### After Task 1 (Webhook Service)
- [ ] src/webhooks.js created
- [ ] deliverWebhook() function with retry logic
- [ ] notifyAgent() function
- [ ] Exponential backoff: 0s, 1s, 2s, 4s
- [ ] Timeout handling (30s per request)
- [ ] Structured logging

### After Task 2 (Payment Integration)
- [ ] Webhooks integrated into payment endpoint
- [ ] Conditional logic: webhook vs hub processing
- [ ] Backward compatible (no webhook = hub processes)
- [ ] Webhook failures logged

### After Task 3 (Completion Endpoint)
- [ ] POST /api/jobs/:uuid/complete endpoint created
- [ ] API key authentication working
- [ ] Job status validation (paid/in_progress only)
- [ ] Agent stats updated (total_jobs, total_earned)

### After Task 4 (Database Tracking)
- [ ] webhook_deliveries table created
- [ ] logWebhookDelivery() function added
- [ ] Webhook attempts logged to database

### After Task 5 (In-Progress Status)
- [ ] markJobInProgress() helper added
- [ ] Agents can mark jobs in-progress via API

### After Task 6 (Documentation)
- [ ] docs/WEBHOOKS.md created
- [ ] Integration guide complete
- [ ] Test script created (optional)

## Final Verification Commands

```bash
# 1. Server starts successfully
npm start
# Expected: "Agent Economy Hub v0.9.0"

# 2. Webhook service loads
node -e "const w = require('./src/webhooks'); console.log(typeof w.deliverWebhook)"
# Expected: "function"

# 3. Check database schema
psql $DATABASE_URL -c "\d webhook_deliveries"
# Expected: Table definition displayed

# 4. Test completion endpoint (requires valid job UUID and API key)
curl -X POST http://localhost:7378/api/jobs/test-uuid/complete \
  -H "Content-Type: application/json" \
  -d '{"apiKey": "test", "output": {"test": true}}'
# Expected: 404 or 401 (endpoint exists)
```

## Success Criteria (Final)

All must be true:
- [ ] External agents notified via webhook when job paid
- [ ] Webhook retry logic works (4 attempts, exponential backoff)
- [ ] POST /api/jobs/:uuid/complete endpoint works
- [ ] API key authentication prevents unauthorized completions
- [ ] Hub processes jobs for agents without webhook_url (backward compatible)
- [ ] Database tracks webhook deliveries
- [ ] Documentation complete
- [ ] No breaking changes to existing payment flow

</verification>

<success_criteria>

## Phase 6 Complete When:

### Functional Requirements ✅
1. **Webhook Delivery**:
   - Agents notified via POST to webhook_url when jobs paid
   - Payload includes jobUuid, agentId, skillId, input, price
   - Retry logic (4 attempts with exponential backoff)
   - Timeout handling (30s per HTTP request)
   - 4xx errors abort (no retry), 5xx errors retry

2. **Agent Callbacks**:
   - POST /api/jobs/:uuid/complete endpoint works
   - API key authentication required
   - Job status validation (must be paid or in_progress)
   - Agent stats updated (total_jobs, total_earned)

3. **Backward Compatibility**:
   - Agents WITHOUT webhook_url: Hub processes jobs (Phase 3/4 behavior)
   - Agents WITH webhook_url: Hub notifies, agents process
   - No breaking changes to existing payment flow

### Technical Requirements ✅
1. **Code Quality**:
   - Webhook logic centralized in src/webhooks.js
   - Clean separation: webhook vs hub processing paths
   - Structured logging for all webhook events
   - Error handling for all edge cases

2. **Database**:
   - webhook_deliveries table tracks all attempts
   - Indexes for performance (job_id, agent_id, success)
   - Job status supports 'in_progress'
   - Agent stats updated atomically

3. **Security**:
   - API key authentication for agent callbacks
   - Webhook URLs must be HTTPS (validation)
   - No secrets in webhook payloads
   - SQL injection prevention (parameterized queries)

### Documentation Requirements ✅
1. **Integration Guide**:
   - docs/WEBHOOKS.md explains full flow
   - Example payloads and responses
   - Error handling documented
   - Security best practices included

2. **Code Comments**:
   - Webhook service functions documented
   - API endpoint behavior documented
   - Retry strategy explained in comments

## Unblocks

Phase 6 completion unblocks:
- ✅ **Multi-agent marketplace**: External agents can join
- ✅ **Phase 12**: E2E testing (can test webhook integration)
- ✅ **Scalability**: Hub no longer processes all jobs itself
- ✅ **Agent ecosystem**: Developers can build external agents

## Not In Scope (Deferred)

These are explicitly NOT part of Phase 6:
- ❌ Dead letter queue (just log failures)
- ❌ Webhook signature verification (use HTTPS + API key)
- ❌ Webhook UI dashboard (just database logs)
- ❌ Job timeouts (agents responsible for their own timeouts)
- ❌ Webhook rate limiting (assume agents are trusted)
- ❌ Webhook payload compression
- ❌ Webhook retries beyond 4 attempts

</success_criteria>

<output>

## Deliverables

### Code Files Created
1. **src/webhooks.js** — Webhook delivery service (new)
   - deliverWebhook() with retry logic
   - notifyAgent() helper
   - Exponential backoff implementation
   - Structured logging

2. **docs/WEBHOOKS.md** — Integration guide (new)
   - Webhook flow documentation
   - Payload and response formats
   - Agent implementation guide
   - Testing instructions

3. **scripts/test-webhook.js** — Test server (optional, new)
   - Simple webhook receiver for testing

### Code Files Modified
1. **src/hub.js** — Payment endpoint enhanced
   - Webhook notification after payment verification
   - Conditional logic: webhook vs hub processing
   - POST /api/jobs/:uuid/complete endpoint added
   - API key authentication

2. **src/db.js** — Database schema and helpers
   - webhook_deliveries table added
   - logWebhookDelivery() function
   - markJobInProgress() helper (optional)
   - Indexes for webhook queries

### User Experience Improvements
- External agents can receive job notifications
- Agents can process jobs on their own infrastructure
- Hub no longer bottleneck for job processing
- Marketplace can scale to many agents

### Architecture Changes
- Payment flow now forks: webhook path vs hub processing path
- Agents responsible for their own processing
- Hub becomes coordinator, not processor
- Database tracks webhook health

## Files to Commit

```bash
# Task 1
git add src/webhooks.js
git commit -m "feat(06-01): create webhook delivery service with retry logic

Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>"

# Task 2
git add src/hub.js
git commit -m "feat(06-01): integrate webhook notifications into payment flow

Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>"

# Task 3
git add src/hub.js
git commit -m "feat(06-01): add agent job completion endpoint

Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>"

# Task 4
git add src/db.js src/webhooks.js
git commit -m "feat(06-01): add webhook delivery tracking to database

Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>"

# Task 5
git add src/db.js src/hub.js
git commit -m "feat(06-01): support in_progress status for agent jobs

Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>"

# Task 6
git add docs/WEBHOOKS.md scripts/test-webhook.js
git commit -m "docs(06-01): add webhook integration guide

Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>"
```

## Next Phase Preview

After Phase 6 completion, proceed to:

**Phase 7: Input Validation & Error Handling**
- Validate wallet addresses (Ethereum address format)
- Validate job prices (positive numbers, match skill price)
- Validate agent/skill IDs (exist in database)
- Better error messages for users
- SQL injection prevention (already partially done)

**To start**: `/gsd:plan-phase 7`

</output>

---

**Estimated Time**: 2-3 hours
**Complexity**: Medium (HTTP client, retry logic, database tracking)
**Risk Level**: Medium (new async behavior, backward compatibility critical)
**Dependencies**: Phase 3 complete (payment flow exists), axios installed

**Budget Impact**:
- Development: $0 (no additional API calls)
- Webhook delivery: ~7s max per job (4 attempts + delays)
- No external dependencies beyond axios

**Critical Success Factor**: Backward compatibility. Agents without webhook_url MUST continue to work exactly as before (Phases 3-5 behavior).

---

*Plan created: 2026-02-03*
*Phase: 6 of 13*
*Mode: YOLO (auto-execute)*
