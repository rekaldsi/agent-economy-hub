# Phase 4 Plan 1: Replicate Image Generation Integration

<objective>
Integrate Replicate API for image generation services, enabling users to pay for AI-generated images. Add 5 visual services (text-to-image, style transfer, etc.) that call Replicate models server-side, store image URLs in output_data, and display results on job pages.
</objective>

<execution_context>
## What We're Building

**Core Feature**: Image generation services powered by Replicate API

**Current State** (from Phase 3):
- ✅ Payment → AI processing flow working
- ✅ Text services return JSON results
- ✅ Results stored in `jobs.output_data`
- ✅ Job status updates: pending → paid → completed
- ❌ NO image generation capability
- ❌ Only 17 text services (no visual services)

**Target State**:
```
POST /api/jobs/:uuid/pay (image service)
  ↓
1. Verify payment on-chain ✅ (working)
2. Update status: paid ✅ (working)
3. Fetch skill details ✅ (working)
4. ⭐ NEW: Check if service uses Replicate (useReplicate flag)
5. ⭐ NEW: Call Replicate API with model + prompt
6. ⭐ NEW: Wait for image generation (async polling)
7. ⭐ NEW: Store image URLs in output_data
8. Update status: completed ✅ (working)
9. Return success response ✅ (working)
```

**Success**: User pays $0.50 → receives Flux-generated image URL in ~10-30 seconds
</execution_context>

<context>
## Project Context

**Tech Stack**:
- Backend: Node.js + Express
- AI: Claude Sonnet 4 (text services) + Replicate (image services)
- Database: PostgreSQL on Railway
- Payment: USDC on Base network

**Replicate API**:
- Async API: Start prediction → Poll status → Get result
- Models to use:
  - **black-forest-labs/flux-schnell** (fast, high quality)
  - **stability-ai/sdxl** (versatile, well-tested)
  - **tencentarc/photomaker** (portrait generation)
- API Key: Already configured as `REPLICATE_API_TOKEN` in .env
- Docs: https://replicate.com/docs/get-started/nodejs

**Current Service Architecture** (from Phase 3):
```javascript
// src/ai.js - Text services
async function generateWithAI(serviceKey, userMessage) {
  const service = getService(serviceKey);
  const response = await anthropic.messages.create({...});
  return JSON.parse(response);
}

// src/hub.js - Payment endpoint
const aiResult = await generateWithAI(serviceKey, userInput);
await db.updateJobStatus(job.id, 'completed', {
  output_data: JSON.stringify(aiResult)
});
```

**New Service Types Needed**:
1. **text-to-image** — Generate image from text prompt
2. **image-portrait** — Generate portraits/headshots
3. **image-logo** — Generate logos and branding
4. **image-product** — Product photography mockups
5. **image-style** — Apply artistic styles to descriptions

**Service Definition Pattern** (services.js):
```javascript
{
  name: 'Image Generation',
  category: 'visual',
  description: 'Generate images from text prompts',
  price: 0.50,
  estimatedTime: '30 seconds',
  inputLabel: 'Describe the image you want',
  inputPlaceholder: 'e.g., A futuristic city at sunset',
  useReplicate: true,  // ⭐ NEW FLAG
  replicateModel: 'black-forest-labs/flux-schnell',  // ⭐ NEW FIELD
  systemPrompt: null  // Not used for Replicate services
}
```

**Key Decisions from PROJECT.md**:
- Server-side integration (keep API key secret)
- Return URLs to frontend (don't store image blobs)
- Use Flux Schnell for speed (not Flux Pro for cost)
- Direct processing (no queue, inline like text services)

**Budget Constraint**: Minimize Replicate API costs
- Flux Schnell: ~$0.003 per image
- SDXL: ~$0.0055 per image
- User pricing: $0.50-1.50 per image
- Healthy margin, but watch usage

## Recent Work (Phases 1-3)

**Phase 1**: Environment setup, dependencies installed
**Phase 2**: Payment verification, security hardening
**Phase 3**: Payment → AI text generation flow (✅ complete)
- Created `src/ai.js` for text generation
- Payment endpoint triggers AI processing
- Results stored in output_data
- Error handling and logging

**Unblocked By Phase 3**:
- Payment → processing → completion flow working
- Can build parallel image processing path
- Database schema supports any JSON in output_data

## Known Constraints

1. **Async API**: Replicate is async (not instant like Claude)
   - Start prediction → Get prediction ID
   - Poll for status (pending → processing → succeeded)
   - Average latency: 10-30 seconds (model dependent)

2. **Different Response Format**:
   - Text services: JSON objects with structured fields
   - Image services: Array of URLs
   - Need to handle both in output_data

3. **No Webhooks in V1**: Replicate supports webhooks but we'll poll
   - Simpler implementation
   - Can add webhooks in Phase 6 if needed

4. **Rate Limits**: Replicate free tier
   - 100 predictions/day free tier
   - Need to handle rate limit errors gracefully

## Success Criteria

### Functional
- [ ] 5 image services defined in services.js
- [ ] Replicate SDK installed and configured
- [ ] `src/replicate.js` module created
- [ ] Payment endpoint routes image services to Replicate
- [ ] Image URLs stored in `output_data`
- [ ] Job status updates after image generation completes
- [ ] Error handling for Replicate failures (model unavailable, rate limits)

### Technical
- [ ] No breaking changes to text services
- [ ] Timeout protection (max 60s for image generation)
- [ ] Polling interval reasonable (2-3 seconds)
- [ ] Image URLs validated (HTTPS, reachable)
- [ ] Structured logging for Replicate API calls

### User Experience
- [ ] User can pay for image service → receive image URL
- [ ] Results appear on job page within 60 seconds
- [ ] Error messages clear (not technical details)
- [ ] Multiple image formats supported (URL array in output_data)
</context>

<tasks>

## Task 1: Install Replicate SDK

**Objective**: Add Replicate npm package to project dependencies

**Why First**: Need SDK before writing any Replicate code

**Steps**:

1. **Install package**:
   ```bash
   npm install replicate
   ```

2. **Verify installation**:
   ```bash
   npm list replicate
   # Should show: replicate@0.x.x
   ```

3. **Update .env.example** to document REPLICATE_API_TOKEN:
   ```bash
   # Add to .env.example:
   # Replicate (image generation)
   REPLICATE_API_TOKEN=r8_...
   ```

**Verification**:
```bash
node -e "console.log(require('replicate'))"
# Should output: [Function: Replicate]
```

**Deliverable**:
- `package.json` and `package-lock.json` updated
- `.env.example` documents REPLICATE_API_TOKEN
- SDK can be imported without errors

**Commit**: `chore(04-01): install Replicate SDK`

---

## Task 2: Create Replicate Service Module

**Objective**: Build `src/replicate.js` module for image generation via Replicate API

**Why Second**: Isolate Replicate logic (same pattern as ai.js for Claude)

**Implementation**:

**Create**: `src/replicate.js`

**Code**:
```javascript
// src/replicate.js
// Image Generation Module - Replicate API integration

const Replicate = require('replicate');

// Initialize Replicate client
const replicate = new Replicate({
  auth: process.env.REPLICATE_API_TOKEN
});

/**
 * Generate image using Replicate API
 * @param {string} modelId - Replicate model ID (e.g., "black-forest-labs/flux-schnell")
 * @param {string} prompt - User's image description
 * @param {Object} options - Additional model parameters (optional)
 * @returns {Promise<Object>} Result with image URLs
 * @throws {Error} If model not found or generation fails
 */
async function generateImage(modelId, prompt, options = {}) {
  if (!process.env.REPLICATE_API_TOKEN) {
    throw new Error('REPLICATE_API_TOKEN not configured');
  }

  try {
    console.log(JSON.stringify({
      timestamp: new Date().toISOString(),
      event: 'replicate_start',
      modelId: modelId,
      promptLength: prompt.length
    }));

    const startTime = Date.now();

    // Start prediction
    const input = {
      prompt: prompt,
      ...options
    };

    // Run prediction and wait for completion
    const output = await replicate.run(modelId, { input });

    const duration = Date.now() - startTime;

    console.log(JSON.stringify({
      timestamp: new Date().toISOString(),
      event: 'replicate_complete',
      modelId: modelId,
      duration: duration,
      imageCount: Array.isArray(output) ? output.length : 1
    }));

    // Normalize output format
    if (Array.isArray(output)) {
      return { images: output };
    } else if (typeof output === 'string') {
      return { images: [output] };
    } else {
      return { images: [output.toString()] };
    }

  } catch (error) {
    console.error(JSON.stringify({
      timestamp: new Date().toISOString(),
      event: 'replicate_error',
      modelId: modelId,
      error: error.message,
      stack: error.stack
    }));
    throw error;
  }
}

/**
 * Get available Replicate models
 * @returns {Object} Map of model names to IDs
 */
function getModels() {
  return {
    'flux-schnell': 'black-forest-labs/flux-schnell',
    'sdxl': 'stability-ai/sdxl:39ed52f2a78e934b3ba6e2a89f5b1c712de7dfea535525255b1aa35c5565e08b',
    'photomaker': 'tencentarc/photomaker:ddfc2b08d209f9fa8c1eca692712918bd449f695dabb4a958da31802a9570fe4'
  };
}

module.exports = {
  generateImage,
  getModels
};
```

**Features**:
- Async polling built-in (replicate.run waits for completion)
- Structured logging (start, complete, error events)
- Normalized output format (always returns {images: [urls]})
- Model ID abstraction (can use short names)
- Error handling with context

**Verification**:
```bash
# Test module loads
node -e "const r = require('./src/replicate'); console.log(r.getModels())"
# Should output model map
```

**Deliverable**:
- `src/replicate.js` file created (~100 lines)
- Exported functions: generateImage, getModels
- Structured logging implemented

**Commit**: `feat(04-01): create Replicate image generation module`

---

## Task 3: Add Visual Services to services.js

**Objective**: Define 5 image generation services with Replicate configuration

**Why Third**: Need service definitions before wiring to payment endpoint

**Implementation**:

**File**: `src/services.js`

**Location**: After existing services (after line ~606, before exports)

**Code to Add**:
```javascript
  // ============================================
  // VISUAL SERVICES (image generation)
  // ============================================
  image_generate: {
    name: 'Image Generation',
    category: 'visual',
    description: 'Generate high-quality images from text descriptions',
    price: 0.50,
    estimatedTime: '30 seconds',
    inputLabel: 'Describe the image you want',
    inputPlaceholder: 'e.g., A futuristic city at sunset with flying cars',
    useReplicate: true,
    replicateModel: 'black-forest-labs/flux-schnell',
    systemPrompt: null  // Not used for Replicate services
  },

  image_portrait: {
    name: 'Portrait Generation',
    category: 'visual',
    description: 'Generate realistic portraits and headshots',
    price: 0.75,
    estimatedTime: '45 seconds',
    inputLabel: 'Describe the portrait',
    inputPlaceholder: 'e.g., Professional headshot of a woman in her 30s, business attire',
    useReplicate: true,
    replicateModel: 'tencentarc/photomaker',
    systemPrompt: null
  },

  image_logo: {
    name: 'Logo Design',
    category: 'visual',
    description: 'Generate logo concepts and brand marks',
    price: 1.00,
    estimatedTime: '40 seconds',
    inputLabel: 'Describe your brand and desired logo style',
    inputPlaceholder: 'e.g., Minimalist tech startup logo with blue and white colors',
    useReplicate: true,
    replicateModel: 'black-forest-labs/flux-schnell',
    systemPrompt: null
  },

  image_product: {
    name: 'Product Mockup',
    category: 'visual',
    description: 'Generate product photography and mockups',
    price: 0.60,
    estimatedTime: '35 seconds',
    inputLabel: 'Describe the product and setting',
    inputPlaceholder: 'e.g., Sleek smartphone on a marble desk with natural lighting',
    useReplicate: true,
    replicateModel: 'stability-ai/sdxl',
    systemPrompt: null
  },

  image_style: {
    name: 'Artistic Style',
    category: 'visual',
    description: 'Generate images with specific artistic styles',
    price: 0.55,
    estimatedTime: '35 seconds',
    inputLabel: 'Describe the scene and artistic style',
    inputPlaceholder: 'e.g., Mountain landscape in Van Gogh impressionist style',
    useReplicate: true,
    replicateModel: 'black-forest-labs/flux-schnell',
    systemPrompt: null
  }
```

**Service Key Mapping**:
- `image_generate` → flux-schnell (general purpose, fast)
- `image_portrait` → photomaker (specialized for faces)
- `image_logo` → flux-schnell (clean, simple output)
- `image_product` → sdxl (high detail, good for products)
- `image_style` → flux-schnell (artistic, versatile)

**Pricing Rationale**:
- Flux Schnell: $0.50-0.55 (fast, low cost to us)
- PhotoMaker: $0.75 (specialized, slightly slower)
- Logo: $1.00 (premium service, design work)
- SDXL: $0.60 (higher cost model)

**Verification**:
```bash
node -e "const s = require('./src/services'); console.log(Object.keys(s.SERVICES).filter(k => s.SERVICES[k].useReplicate))"
# Should output: [ 'image_generate', 'image_portrait', 'image_logo', 'image_product', 'image_style' ]
```

**Deliverable**:
- 5 new services in services.js
- Each has `useReplicate: true` flag
- Each has `replicateModel` field
- Service keys match naming convention

**Commit**: `feat(04-01): add 5 visual services with Replicate config`

---

## Task 4: Wire Replicate into Payment Endpoint

**Objective**: Route image services to Replicate instead of Claude in payment endpoint

**Why Fourth**: Core integration that enables image generation

**Implementation**:

**File**: `src/hub.js`

**Location**: POST `/api/jobs/:uuid/pay` endpoint (lines ~1567-1660)

**Current Logic** (simplified):
```javascript
// After payment verification...
const skill = await db.getSkill(job.skill_id);
const serviceKey = skill.service_key || ...;

const aiResult = await generateWithAI(serviceKey, userInput);

await db.updateJobStatus(job.id, 'completed', {
  output_data: JSON.stringify(aiResult)
});
```

**New Logic** (add service type routing):

1. **Add import** at top of file:
```javascript
const { generateImage } = require('./replicate');
```

2. **Update AI processing section** (lines ~1620-1650):
```javascript
// After payment verification and status update to 'paid'...
try {
  // Fetch skill to get service configuration
  const skill = await db.getSkill(job.skill_id);
  if (!skill) throw new Error('Skill not found');

  const serviceKey = skill.service_key ||
    skill.name.toLowerCase().replace(/[^a-z0-9]/g, '');

  // Get service definition
  const service = getService(serviceKey);
  if (!service) throw new Error(`Unknown service: ${serviceKey}`);

  // Extract user input
  const userInput = job.input_data.prompt ||
    job.input_data.input ||
    JSON.stringify(job.input_data);

  let result;

  // ⭐ NEW: Route to appropriate service
  if (service.useReplicate) {
    // IMAGE GENERATION via Replicate
    console.log(JSON.stringify({
      timestamp: new Date().toISOString(),
      event: 'image_processing_start',
      jobUuid: job.job_uuid,
      serviceKey: serviceKey,
      model: service.replicateModel
    }));

    const startTime = Date.now();

    // Add timeout protection (60 seconds for images)
    const IMAGE_TIMEOUT = 60000;

    result = await Promise.race([
      generateImage(service.replicateModel, userInput),
      new Promise((_, reject) =>
        setTimeout(() => reject(new Error('Image generation timeout')), IMAGE_TIMEOUT)
      )
    ]);

    const duration = Date.now() - startTime;

    console.log(JSON.stringify({
      timestamp: new Date().toISOString(),
      event: 'image_processing_complete',
      jobUuid: job.job_uuid,
      duration: duration,
      imageCount: result.images ? result.images.length : 0
    }));

  } else {
    // TEXT GENERATION via Claude (existing logic)
    console.log(JSON.stringify({
      timestamp: new Date().toISOString(),
      event: 'ai_processing_start',
      jobUuid: job.job_uuid,
      serviceKey: serviceKey
    }));

    const startTime = Date.now();

    const AI_TIMEOUT = 30000;

    result = await Promise.race([
      generateWithAI(serviceKey, userInput),
      new Promise((_, reject) =>
        setTimeout(() => reject(new Error('AI generation timeout')), AI_TIMEOUT)
      )
    ]);

    const duration = Date.now() - startTime;

    console.log(JSON.stringify({
      timestamp: new Date().toISOString(),
      event: 'ai_processing_complete',
      jobUuid: job.job_uuid,
      duration: duration
    }));
  }

  // Store result and mark completed
  await db.updateJobStatus(job.id, 'completed', {
    output_data: JSON.stringify(result),
    completed_at: new Date().toISOString()
  });

  res.json({
    success: true,
    jobUuid: job.job_uuid,
    status: 'completed',
    serviceType: service.useReplicate ? 'image' : 'text'
  });

} catch (processingError) {
  // Error handling (same as before)...
}
```

**Key Changes**:
- ✅ Import generateImage from replicate.js
- ✅ Check service.useReplicate flag
- ✅ Route to Replicate or Claude accordingly
- ✅ Different timeout (60s for images vs 30s for text)
- ✅ Different logging events (image_processing vs ai_processing)
- ✅ Return service type in response

**Add getService import** at top (if not already there):
```javascript
const { getService } = require('./services');
```

**Verification**:
- Server starts without errors
- No circular dependencies
- Import paths correct

**Deliverable**:
- Replicate integration in payment endpoint
- Service type routing (text vs image)
- Separate timeouts for each type
- Enhanced logging

**Commit**: `feat(04-01): wire Replicate into payment endpoint`

---

## Task 5: Add Database Migration for Image Services

**Objective**: Ensure skills table can store image service definitions

**Why Fifth**: Database needs to support new service types

**Steps**:

1. **Check if migration needed**:
   - Phase 3 already added `service_key` column
   - Existing schema supports useReplicate flag (stored in service definition, not database)
   - No new columns needed

2. **Seed image services** (if needed):
   - Image services will be seeded when agent registers
   - OR add to initDB if we want them pre-seeded

**Decision**: No migration needed
- Services are defined in services.js (code)
- Database stores service_key (already added in Phase 3)
- Replicate config is in services.js, not database

**Verification**:
```bash
# Check existing skills
node -e "
const db = require('./src/db');
db.query('SELECT id, name, service_key FROM skills LIMIT 5')
  .then(r => console.log(r.rows));
"
```

**Deliverable**:
- Confirmed no database changes needed
- Image services ready to be seeded (via registration or manual)

**Note**: Mark this task as "N/A - No migration needed" in summary

---

## Task 6: Manual End-to-End Testing

**Objective**: Verify image generation flow works with real Replicate API

**Why Last**: Integration testing before marking phase complete

**Test Scenarios**:

### Test 1: Successful Image Generation

**Steps**:
1. Start server: `npm start`
2. Open browser: `http://localhost:7378`
3. Connect MetaMask wallet
4. Select "Image Generation" service
5. Enter prompt: "A futuristic city at sunset with flying cars"
6. Create job (POST /api/jobs)
7. Pay 0.50 USDC with MetaMask
8. Submit payment (POST /api/jobs/:uuid/pay with txHash)
9. Wait for response (~20-40 seconds)
10. Verify job page shows image URL

**Expected Results**:
- Job status: `completed`
- `output_data` contains: `{ images: ["https://replicate.delivery/..."] }`
- Image URL is HTTPS and reachable
- Image loads when pasted in browser
- Timestamps: `paid_at` and `completed_at` populated

### Test 2: Multiple Image Services

**Steps**:
1. Test each of the 5 image services
2. Verify different models produce different results

**Expected**:
- `image_generate` uses flux-schnell (fast, general)
- `image_portrait` uses photomaker (face-focused)
- `image_product` uses sdxl (high detail)

### Test 3: Replicate Error Handling

**Steps**:
1. Temporarily break REPLICATE_API_TOKEN (invalid value)
2. Try to generate image
3. Check error handling

**Expected**:
- Job status: `failed`
- `output_data`: `{ error: 'Image generation failed', message: '...' }`
- HTTP 500 response with error details
- Clear error message (not token leak)

### Test 4: Timeout Protection

**Steps**:
1. Monitor logs during image generation
2. Check duration is < 60 seconds

**Expected**:
- Image generation: 15-45 seconds (model dependent)
- Timeout triggers if > 60 seconds
- Job marked as failed if timeout occurs

### Test 5: Text Services Still Work

**Steps**:
1. Generate a brainstorm (text service)
2. Verify it still uses Claude, not Replicate

**Expected**:
- Text services unaffected
- Routing logic works correctly
- Both service types can coexist

**Verification Commands**:
```bash
# Check image jobs in database
psql $DATABASE_URL -c "SELECT job_uuid, status, output_data->>'images' as image_urls FROM jobs WHERE status = 'completed' ORDER BY created_at DESC LIMIT 3;"

# Check for image service skills
node -e "
const { SERVICES } = require('./src/services');
Object.entries(SERVICES)
  .filter(([k,v]) => v.useReplicate)
  .forEach(([k,v]) => console.log(k, v.replicateModel));
"

# Test Replicate module directly
node -e "
const { generateImage } = require('./src/replicate');
generateImage('black-forest-labs/flux-schnell', 'a cat wearing a hat')
  .then(r => console.log('Success:', r.images[0]))
  .catch(e => console.error('Error:', e.message));
"
```

**Deliverable**:
- Test results documented
- Screenshots of generated images (optional)
- Confirmation that image generation works end-to-end

---

</tasks>

<verification>

## Pre-Execution Checklist

Before starting implementation:
- [ ] Phase 3 complete (payment → AI flow working)
- [ ] REPLICATE_API_TOKEN in .env is valid
- [ ] Node.js version supports async/await (v14+)
- [ ] Server starts without errors
- [ ] Can access http://localhost:7378

## Post-Task Checkpoints

### After Task 1 (SDK Installation)
- [ ] Replicate package in package.json
- [ ] `npm list replicate` shows version
- [ ] .env.example documents REPLICATE_API_TOKEN
- [ ] Can import replicate without errors

### After Task 2 (Replicate Module)
- [ ] `src/replicate.js` file created
- [ ] Exports generateImage and getModels functions
- [ ] Module loads without errors
- [ ] Structured logging implemented

### After Task 3 (Visual Services)
- [ ] 5 new services in services.js
- [ ] Each has useReplicate: true flag
- [ ] Each has replicateModel field
- [ ] getService() returns image services correctly

### After Task 4 (Payment Integration)
- [ ] Replicate import added to hub.js
- [ ] Service type routing implemented (text vs image)
- [ ] Different timeouts (60s images, 30s text)
- [ ] Server starts without errors

### After Task 5 (Database)
- [ ] Confirmed no migration needed
- [ ] Existing schema supports image services

### After Task 6 (Testing)
- [ ] Image generation works end-to-end
- [ ] Image URLs stored in database
- [ ] Images load in browser
- [ ] Text services still work
- [ ] Error handling tested

## Final Verification Commands

```bash
# 1. Server starts successfully
npm start
# Expected: "Server running on port 7378"

# 2. Image services available
curl http://localhost:7378/health | jq '.services' | grep image_
# Expected: image_generate, image_portrait, etc.

# 3. Replicate module works
node -e "const r = require('./src/replicate'); console.log(r.getModels())"
# Expected: Object with model IDs

# 4. Services have Replicate config
node -e "const s = require('./src/services'); console.log(s.SERVICES.image_generate)"
# Expected: Service object with useReplicate: true

# 5. Recent image jobs exist
psql $DATABASE_URL -c "SELECT COUNT(*) FROM jobs WHERE status='completed';"
# Expected: At least 1 completed job after testing
```

## Success Criteria (Final)

All must be true:
- [ ] Replicate SDK installed
- [ ] 5 image services defined
- [ ] src/replicate.js module created
- [ ] Payment endpoint routes to Replicate for image services
- [ ] Image URLs stored in database
- [ ] Manual test: Pay → Generate image → Receive URL
- [ ] Text services still work (no regression)
- [ ] Error handling for Replicate failures
- [ ] Timeout protection (60s max)
- [ ] Structured logging

</verification>

<success_criteria>

## Phase 4 Complete When:

### Functional Requirements ✅
1. **Image Generation Works**:
   - User pays for image service → receives image URL
   - Multiple models supported (Flux, SDXL, PhotoMaker)
   - Results appear on job page within 60 seconds

2. **Service Variety**:
   - 5 distinct image services available
   - Each uses appropriate Replicate model
   - Pricing reflects generation cost + margin

3. **Integration Quality**:
   - Image services route to Replicate
   - Text services still route to Claude
   - Both work simultaneously without conflicts

### Technical Requirements ✅
1. **Code Quality**:
   - Replicate logic in separate module (`src/replicate.js`)
   - Service type routing clean and maintainable
   - No code duplication between text and image paths

2. **Performance**:
   - Image generation: 15-45 seconds average
   - Timeout protection: 60s max
   - Polling efficient (no excessive API calls)

3. **Error Handling**:
   - Rate limit errors handled gracefully
   - Model unavailable errors caught
   - Timeout errors mark job as failed
   - Error messages don't leak API tokens

### Testing Requirements ✅
1. **Manual Tests Pass**:
   - Successful image generation (at least 2 different services)
   - Text service regression test (brainstorm still works)
   - Error handling test (invalid API key)
   - Timeout protection test (verified in logs)

2. **Database Verification**:
   - At least 1 image job with status='completed'
   - `output_data` contains `{ images: ["https://..."] }`
   - Image URLs are reachable (HTTP 200)

### Documentation Requirements ✅
1. **Code Comments**:
   - Replicate module has JSDoc comments
   - Service routing logic documented
   - Model selection rationale in comments

2. **Logs**:
   - Image processing events logged with timestamps
   - Replicate API calls tracked (start, complete, error)
   - Duration metrics captured

## Unblocks

Phase 4 completion unblocks:
- ✅ **Phase 5**: Results Display & Formatting (can display both text and images)
- ✅ **Phase 12**: End-to-End Testing (visual services ready to test)

## Not In Scope (Deferred)

These are explicitly NOT part of Phase 4:
- ❌ Image display formatting in UI (Phase 5)
- ❌ Image editing/manipulation features
- ❌ Replicate webhook integration (using polling for now)
- ❌ Image storage (storing URLs only, not files)
- ❌ Multiple images per job (single image per generation)
- ❌ Custom model parameters (using defaults)
- ❌ Image upscaling or enhancement
- ❌ Batch image generation

</success_criteria>

<output>

## Deliverables

### Code Files Created
1. **src/replicate.js** (NEW) — Replicate API integration module
   - `generateImage(modelId, prompt, options)` function
   - `getModels()` helper for model mapping
   - Structured logging
   - Error handling

### Code Files Modified
1. **src/services.js** — Service definitions
   - Added 5 visual services (image_generate, image_portrait, image_logo, image_product, image_style)
   - Each with useReplicate: true flag
   - Model mappings for each service

2. **src/hub.js** — Payment endpoint
   - Import generateImage from replicate.js
   - Service type routing (text vs image)
   - Separate timeout handling (60s for images)
   - Enhanced logging for image generation

3. **package.json** — Dependencies
   - Added `replicate` package

4. **.env.example** — Environment documentation
   - Added REPLICATE_API_TOKEN documentation

### Service Catalog Updates
- Total services: 17 → 22 (added 5 image services)
- New category: "visual" (5 services)
- Price range: $0.50-1.00 per image

### Testing Evidence
- Manual test results documented
- Image URLs from test generations
- Verification that text services still work

## Files to Commit

```bash
git add package.json package-lock.json
git commit -m "chore(04-01): install Replicate SDK

Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>"

git add src/replicate.js
git commit -m "feat(04-01): create Replicate image generation module

Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>"

git add src/services.js
git commit -m "feat(04-01): add 5 visual services with Replicate config

Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>"

git add src/hub.js
git commit -m "feat(04-01): wire Replicate into payment endpoint

Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>"

git add .env.example
git commit -m "docs(04-01): document REPLICATE_API_TOKEN in env example

Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>"
```

## Next Phase Preview

After Phase 4 completion, proceed to:

**Phase 5: Results Display & Formatting**
- Format text results (preserve markdown, code blocks)
- Display images with proper rendering
- Pretty-print JSON for structured data
- Loading states while processing
- Build on existing output_data structure

**To start**: `/gsd:plan-phase 5`

</output>

---

**Estimated Time**: 1.5-2 hours
**Complexity**: Medium-High (new API integration)
**Risk Level**: Medium (async API, new service type)
**Dependencies**: Phase 3 complete (payment → processing flow)

**Budget Impact**:
- Development: ~$1-2 in Replicate costs for testing (10-20 test images)
- Per-image cost: ~$0.003-0.006 Replicate API fees
- User pricing: $0.50-1.00 per image
- Healthy margin: ~90-95% gross margin

---

*Plan created: 2026-02-03*
*Phase: 4 of 13*
*Mode: YOLO (auto-execute)*
