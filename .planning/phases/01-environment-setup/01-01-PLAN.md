# Phase 1 Plan 1: Environment Setup & Dependencies

## Objective

Install npm dependencies, create and configure `.env` file with API keys, verify database connectivity, and confirm server startup. Seed MrMagoochi agent in database for testing.

**Success**: Server starts without errors, database connection verified, application ready for development work.

---

## Execution Context

**Phase**: 1 of 13 â€” Environment Setup & Dependencies
**Milestone**: Launch v1.0
**Complexity**: Low (configuration & setup)
**Estimated Time**: 30-45 minutes

**Prior Context**:
- Brownfield codebase (~60% complete)
- Missing: node_modules, .env file
- Database schema exists but may not be initialized
- User has API keys ready (Anthropic, Replicate, Database URL)

**Codebase References**:
- @.planning/codebase/STACK.md (technology dependencies)
- @.planning/codebase/CONCERNS.md (known issues #1, #2)
- @.planning/codebase/INTEGRATIONS.md (API requirements)

---

## Context

### Current State
- **Dependencies**: Not installed (`node_modules/` does not exist)
- **Environment**: No `.env` file (only `.env.example` exists)
- **Database**: Unknown if initialized, connection untested
- **Server**: Cannot start without dependencies and configuration

### What We're Building On
- Existing `package.json` with 11 production dependencies
- Existing `.env.example` as template
- Existing `src/db.js` with `initDB()` function
- Existing `src/index.js` with server startup logic

### Dependencies (from package.json)
```json
{
  "@anthropic-ai/sdk": "^0.72.1",
  "@openserv-labs/sdk": "^1.8.2",
  "axios": "^1.6.0",
  "cors": "^2.8.5",
  "dotenv": "^16.3.1",
  "ethers": "^6.16.0",
  "express": "^4.18.2",
  "openai": "^6.17.0",
  "pg": "^8.18.0",
  "uuid": "^13.0.0",
  "zod": "^3.25.76"
}
```

### Required Environment Variables
```bash
# Server
PORT=7378

# AI Services
ANTHROPIC_API_KEY=sk-ant-...    # Required for Claude API
REPLICATE_API_TOKEN=...         # Required for image generation (Phase 4)

# Database
DATABASE_URL=postgresql://...   # Required for PostgreSQL connection

# Blockchain (optional for Phase 1)
WALLET_ADDRESS=0x...
WALLET_PRIVATE_KEY=...

# Marketplace (optional for Phase 1)
OPENSERV_API_KEY=...

# Configuration
REQUIRE_PAYMENT=false
NODE_ENV=development
```

---

## Tasks

### Task 1: Install NPM Dependencies

**Goal**: Install all production dependencies from package.json

**Steps**:
1. Run `npm install` in project root
2. Verify `node_modules/` directory created
3. Check for installation errors or warnings
4. Verify key packages installed:
   - `@anthropic-ai/sdk`
   - `pg` (PostgreSQL)
   - `express`
   - `ethers`

**Expected Output**:
- `node_modules/` directory with ~300+ packages
- `package-lock.json` updated
- No installation errors

**Checkpoint**: Dependencies installed successfully

**Files Modified**: `package-lock.json` (updated)

---

### Task 2: Create and Configure .env File

**Goal**: Create `.env` file with all required API keys and configuration

**Steps**:
1. Copy `.env.example` to `.env`
2. **Prompt user** for required API keys:
   - `ANTHROPIC_API_KEY` (critical for Phase 3)
   - `DATABASE_URL` (critical for this phase)
   - `REPLICATE_API_TOKEN` (can be added in Phase 4 if not available now)
3. Set sensible defaults for optional vars:
   - `PORT=7378`
   - `NODE_ENV=development`
   - `REQUIRE_PAYMENT=false`
4. Validate `.env` file format (no syntax errors)

**Expected Output**:
```.env
PORT=7378
DATABASE_URL=postgresql://user:password@host:port/database
ANTHROPIC_API_KEY=sk-ant-...
REPLICATE_API_TOKEN=r8_...
REQUIRE_PAYMENT=false
NODE_ENV=development
```

**Checkpoint**: `.env` file created with valid credentials

**Files Created**: `.env` (gitignored)

**Important Notes**:
- âš ï¸ **User must provide their actual API keys** - we cannot generate these
- âš ï¸ `.env` file should be gitignored (verify `.gitignore` includes `.env`)
- If user doesn't have DATABASE_URL yet, they can use Railway PostgreSQL or local Postgres

---

### Task 3: Verify Database Connection

**Goal**: Test PostgreSQL connection and initialize schema if needed

**Steps**:
1. Test database connection using `src/db.js`:
   ```bash
   node -e "require('dotenv').config(); const db = require('./src/db.js'); db.query('SELECT NOW()').then(() => console.log('DB connected')).catch(console.error)"
   ```
2. If connection fails, provide troubleshooting guidance:
   - Check DATABASE_URL format
   - Verify database server is running
   - Check network connectivity
   - Verify credentials
3. Once connected, check if schema exists:
   ```bash
   node -e "require('dotenv').config(); const db = require('./src/db.js'); db.query('SELECT COUNT(*) FROM users').then(r => console.log('Schema exists')).catch(() => console.log('Schema missing'))"
   ```
4. If schema missing, run initialization:
   ```bash
   node -e "require('dotenv').config(); const db = require('./src/db.js'); db.initDB().then(() => console.log('Schema initialized')).catch(console.error)"
   ```

**Expected Output**:
- "DB connected" message
- Schema initialized (5 tables: users, agents, skills, jobs, reviews)
- No connection errors

**Checkpoint**: Database connection verified, schema initialized

**Files Read**: `src/db.js:8-98` (initDB function)

---

### Task 4: Verify Server Startup

**Goal**: Confirm Express server starts without errors

**Steps**:
1. Start server in test mode:
   ```bash
   npm start
   ```
2. Watch for startup messages:
   - Expected: "ðŸ¦ž Agent Economy Hub v0.9.0 | http://localhost:7378"
   - If errors, troubleshoot:
     - Missing env vars â†’ Check `.env` file
     - Port in use â†’ Change PORT in `.env`
     - Database errors â†’ Re-verify Task 3
3. Test health check endpoint:
   ```bash
   curl http://localhost:7378/health
   ```
   Expected: `{"status":"healthy"}`
4. Test landing page loads:
   ```bash
   curl http://localhost:7378/ | grep "Agent Economy Hub"
   ```
5. Stop server (Ctrl+C)

**Expected Output**:
- Server starts successfully on port 7378
- Health check returns 200 OK
- Landing page HTML loads
- No runtime errors in console

**Checkpoint**: Server starts and responds to HTTP requests

**Files Read**: `src/index.js:857-871` (server startup)

---

### Task 5: Seed MrMagoochi Agent (Optional)

**Goal**: Create initial agent in database for testing (can defer to Phase 10 if time-constrained)

**Steps**:
1. Create simple seed script or run database commands manually
2. Create MrMagoochi user:
   ```sql
   INSERT INTO users (wallet_address, user_type, name, bio)
   VALUES ('0xa193128362e6de28e6d51eebc98505672ffeb3c5', 'agent', 'MrMagoochi', 'AI-powered creative and research services')
   ON CONFLICT (wallet_address) DO NOTHING;
   ```
3. Create MrMagoochi agent profile:
   ```sql
   INSERT INTO agents (user_id, webhook_url, api_key, is_active)
   VALUES (
     (SELECT id FROM users WHERE wallet_address = '0xa193128362e6de28e6d51eebc98505672ffeb3c5'),
     'http://localhost:7378/webhook/mrmagoochi',
     'hub_' || encode(gen_random_bytes(24), 'hex'),
     true
   )
   ON CONFLICT DO NOTHING;
   ```
4. Optionally create 2-3 test skills (or defer to Phase 10)

**Expected Output**:
- MrMagoochi user exists in database
- MrMagoochi agent profile created
- Agent has valid API key

**Checkpoint**: Test agent seeded (or deferred to Phase 10)

**Files Used**: `src/db.js` (database functions)

**Note**: This task can be **deferred to Phase 10** if you want to move faster to core development. It's nice-to-have but not blocking.

---

## Verification

### Automated Checks
Run these commands to verify phase completion:

```bash
# Check dependencies installed
test -d node_modules && echo "âœ… Dependencies installed" || echo "âŒ Missing node_modules"

# Check .env exists
test -f .env && echo "âœ… .env file created" || echo "âŒ Missing .env"

# Check required env vars
node -e "require('dotenv').config(); const ok = process.env.DATABASE_URL && process.env.ANTHROPIC_API_KEY; console.log(ok ? 'âœ… Required env vars set' : 'âŒ Missing required env vars')"

# Check database connection
node -e "require('dotenv').config(); const db = require('./src/db.js'); db.query('SELECT 1').then(() => console.log('âœ… Database connected')).catch(() => console.log('âŒ Database connection failed'))"

# Check server starts
timeout 5 npm start &>/dev/null && echo "âœ… Server starts" || echo "âš ï¸ Server start check skipped (manual verification needed)"
```

### Manual Verification Checklist
- [ ] `npm install` completed without errors
- [ ] `.env` file exists with DATABASE_URL and ANTHROPIC_API_KEY
- [ ] Database connection successful
- [ ] Database schema initialized (5 tables)
- [ ] Server starts on port 7378
- [ ] Health check endpoint responds
- [ ] Landing page loads in browser
- [ ] No console errors during startup

---

## Success Criteria

### Phase 1 Complete When:
- [x] All npm dependencies installed (`node_modules/` exists)
- [x] `.env` file created with valid API keys
- [x] Database connection verified
- [x] Database schema initialized
- [x] Server starts without errors
- [x] Health check endpoint returns 200
- [x] Application ready for development work

### Unblocks:
- Phase 2: Payment Verification & Security
- Phase 3: Payment â†’ AI Processing Flow
- All subsequent phases

---

## Output

### Files Created
- `.env` (environment configuration, gitignored)

### Files Modified
- `package-lock.json` (dependency lock file)

### Directories Created
- `node_modules/` (npm packages)

### Database Changes
- Schema initialized (users, agents, skills, jobs, reviews tables)
- Optionally: MrMagoochi agent seeded

---

## Troubleshooting Guide

### Problem: npm install fails

**Symptoms**: Error messages during `npm install`

**Solutions**:
1. Check Node.js version: `node --version` (should be >= 18)
2. Clear npm cache: `npm cache clean --force`
3. Delete `package-lock.json` and `node_modules/`, retry
4. Check for network issues or npm registry access

---

### Problem: DATABASE_URL connection fails

**Symptoms**: "ECONNREFUSED" or "connection timeout" errors

**Solutions**:
1. Verify database server is running
2. Check DATABASE_URL format: `postgresql://user:password@host:port/database`
3. Test with `psql` command: `psql $DATABASE_URL`
4. If using Railway, ensure database is provisioned and URL copied correctly
5. Check SSL requirements (some hosts require `?sslmode=require`)

---

### Problem: ANTHROPIC_API_KEY invalid

**Symptoms**: "401 Unauthorized" when testing Claude API

**Solutions**:
1. Verify API key format starts with `sk-ant-`
2. Check key is active in Anthropic console
3. Verify no extra spaces or quotes in `.env` file
4. Test key with curl:
   ```bash
   curl https://api.anthropic.com/v1/messages \
     -H "x-api-key: $ANTHROPIC_API_KEY" \
     -H "anthropic-version: 2023-06-01" \
     -H "content-type: application/json" \
     -d '{"model":"claude-sonnet-4-20250514","max_tokens":10,"messages":[{"role":"user","content":"Hi"}]}'
   ```

---

### Problem: Port 7378 already in use

**Symptoms**: "EADDRINUSE" error on server start

**Solutions**:
1. Change PORT in `.env` to another value (e.g., 7379, 8080)
2. Or kill existing process:
   ```bash
   lsof -ti:7378 | xargs kill -9
   ```

---

## Notes

- **YOLO Mode**: This plan will auto-execute without manual approval checkpoints
- **Budget**: No API costs for this phase (just setup)
- **Time Estimate**: 30-45 minutes if all credentials ready, 1-2 hours if need to provision database
- **Deferrable**: Task 5 (agent seeding) can be deferred to Phase 10 without blocking progress

---

## Next Steps

After Phase 1 completion:

**Immediate**: `/gsd:plan-phase 2` (Payment Verification & Security)

**Or**: `/gsd:execute-plan 01-01` if ready to execute this plan now

---

*Created: 2026-02-03*
*Phase: 1/13*
*Estimated time: 30-45 minutes*
