# Phase 9 Plan 1: Rate Limiting & Basic Ops

<objective>
Add rate limiting to prevent API abuse, implement structured logging for production observability, and add graceful shutdown handlers to ensure clean termination and prevent data loss. This phase provides essential operational safeguards before public launch.
</objective>

<execution_context>
## What We're Building

**Core Feature**: Operational safeguards and cost control

**Current State** (from Phase 8):
- ‚úÖ All API endpoints functional and validated
- ‚úÖ Environment variable validation on startup
- ‚úÖ Request body size limits (100kb default, 500kb for completions)
- ‚úÖ Basic console.log logging
- ‚ùå NO rate limiting (vulnerable to API abuse)
- ‚ùå NO structured logging (hard to debug production issues)
- ‚ùå NO graceful shutdown (DB pool not closed cleanly)
- ‚ùå NO operational health checks

**Current API Endpoints** (16 total):
- **GET Endpoints** (11): Home, agents, agent detail, register form, dashboard, job detail, API reads
- **POST Endpoints** (5): User creation, job creation, payment, job completion, agent registration

**Cost-Critical Endpoints** (need strictest limits):
1. POST `/api/jobs/:uuid/pay` - triggers AI generation ($0.10-$1.00 per call)
2. POST `/api/jobs` - creates job records (database write)
3. POST `/api/register-agent` - creates agent records (database write)

**Why This Matters**:
- A single abuser can rack up $1000+ in API costs in minutes
- Without structured logging, production debugging is nearly impossible
- Unclean shutdowns can corrupt database connections and lose data

**Target State**:
- Rate limiting on all API endpoints (tiered by endpoint type)
- Structured JSON logging with Winston
- Graceful shutdown handlers (SIGTERM, SIGINT)
- Enhanced health check endpoint
- Production-ready operational posture
</execution_context>

<context>
## Project Context

**Tech Stack**:
- Runtime: Node.js 18+
- Framework: Express 4.18
- Database: PostgreSQL with pg connection pool
- No process manager (Railway handles restarts)

**Current Logging** (src/index.js:863-867):
```javascript
console.log(`ü¶û Agent Economy Hub v0.9.0 | http://localhost:${PORT}`);
console.log(`   AI: claude-sonnet-4 | Key: ${ANTHROPIC_API_KEY ? '‚úì' : '‚úó'}`);
console.log(`   DB: ${process.env.DATABASE_URL ? '‚úì' : '‚úó'}`);
```
- Works for development
- Too informal for production
- No log levels, no timestamps, no structured data

**Current Shutdown Behavior**:
- `process.exit(1)` on errors (lines 857, 871)
- No cleanup handlers
- Database pool connections not closed
- In-flight requests abandoned

**Rate Limiting Strategy**:

| Endpoint Type | Limit | Window | Rationale |
|---------------|-------|--------|-----------|
| Job creation (POST /api/jobs) | 10 req/min | per IP | Prevent job spam |
| Payment (POST /api/jobs/:uuid/pay) | 5 req/min | per wallet | Most expensive (AI costs) |
| Agent registration (POST /api/register-agent) | 5 req/min | per IP | Prevent agent spam |
| User creation (POST /api/users) | 10 req/min | per IP | Reasonable for real users |
| Job completion (POST /api/jobs/:uuid/complete) | 20 req/min | per IP | Allow agent webhook callbacks |
| Read endpoints (GET /api/*) | 100 req/min | per IP | Generous for browsing |
| HTML pages (GET /) | 200 req/min | per IP | Very generous for UI |

**Packages to Install**:
- `express-rate-limit` (^7.1.5) - Industry-standard rate limiting middleware
- `winston` (^3.11.0) - Production-grade structured logging

## Recent Work (Phases 1-8)

**Phase 7**: Input Validation & Error Handling
- Added Zod validation for all API endpoints
- User-friendly error messages
- These errors need structured logging now

**Phase 8**: Mobile Responsive & UI Polish
- Added toast notifications for user feedback
- Improved UX for async operations
- Ready for production launch after ops hardening

**Unblocked By Phase 8**:
- UI is production-ready
- Need backend operational hardening to match
- Rate limiting prevents cost overruns
- Logging enables production debugging
</context>

---

## Tasks

## Task 1: Install Rate Limiting and Logging Dependencies

**Goal**: Install express-rate-limit and winston packages

**What to do**:

1. **Install express-rate-limit**:
   ```bash
   npm install express-rate-limit@^7.1.5
   ```

2. **Install winston**:
   ```bash
   npm install winston@^3.11.0
   ```

3. **Verify installation**:
   ```bash
   grep -E "express-rate-limit|winston" package.json
   ```
   Should show both packages in dependencies

**Files Modified**:
- `package.json` (dependencies updated)
- `package-lock.json` (lockfile updated)

**Verification**:
- Both packages appear in package.json dependencies
- npm install completes without errors
- Packages ready for import in Task 2

**Commit Message**:
```
chore(09-01): install express-rate-limit and winston dependencies
```

---

## Task 2: Add Rate Limiting Middleware

**Goal**: Add express-rate-limit middleware to all API endpoints with tiered limits

**What to do**:

1. **Import express-rate-limit in src/index.js** (after line 7):
   ```javascript
   const rateLimit = require('express-rate-limit');
   ```

2. **Create rate limiter instances** (after line 28, before hubRouter mount):
   ```javascript
   // ============================================
   // RATE LIMITING
   // ============================================

   // HTML pages - very generous (200 req/min per IP)
   const htmlPageLimiter = rateLimit({
     windowMs: 60 * 1000, // 1 minute
     max: 200,
     message: 'Too many requests from this IP, please try again later',
     standardHeaders: true, // Return rate limit info in `RateLimit-*` headers
     legacyHeaders: false // Disable `X-RateLimit-*` headers
   });

   // Read-only API endpoints - generous (100 req/min per IP)
   const apiReadLimiter = rateLimit({
     windowMs: 60 * 1000,
     max: 100,
     message: { error: 'Too many API requests, please try again later' },
     standardHeaders: true,
     legacyHeaders: false
   });

   // Job creation - moderate (10 req/min per IP)
   const jobCreationLimiter = rateLimit({
     windowMs: 60 * 1000,
     max: 10,
     message: { error: 'Too many job creation requests, please slow down' },
     standardHeaders: true,
     legacyHeaders: false,
     skipSuccessfulRequests: false // Count all requests
   });

   // Payment processing - strict (5 req/min per IP)
   const paymentLimiter = rateLimit({
     windowMs: 60 * 1000,
     max: 5,
     message: { error: 'Too many payment attempts, please wait before retrying' },
     standardHeaders: true,
     legacyHeaders: false,
     skipSuccessfulRequests: false
   });

   // Agent registration - strict (5 req/min per IP)
   const agentRegistrationLimiter = rateLimit({
     windowMs: 60 * 1000,
     max: 5,
     message: { error: 'Too many registration attempts, please try again later' },
     standardHeaders: true,
     legacyHeaders: false
   });

   // Job completion (webhook callbacks) - allow higher rate (20 req/min per IP)
   const jobCompletionLimiter = rateLimit({
     windowMs: 60 * 1000,
     max: 20,
     message: { error: 'Too many completion requests, please retry later' },
     standardHeaders: true,
     legacyHeaders: false
   });

   // User creation - moderate (10 req/min per IP)
   const userCreationLimiter = rateLimit({
     windowMs: 60 * 1000,
     max: 10,
     message: { error: 'Too many user creation requests, please slow down' },
     standardHeaders: true,
     legacyHeaders: false
   });
   ```

3. **Apply rate limiters to specific endpoints** in src/hub.js:

   You'll need to import the limiters in hub.js. At the top of src/hub.js (after line 3):
   ```javascript
   // Rate limiters will be passed from index.js
   let rateLimiters = {};

   function setRateLimiters(limiters) {
     rateLimiters = limiters;
   }
   ```

   Then export setRateLimiters at the bottom of hub.js:
   ```javascript
   module.exports = router;
   module.exports.setRateLimiters = setRateLimiters;
   ```

   **BETTER APPROACH**: Apply rate limiters in index.js before mounting hubRouter:

   In src/index.js, after creating all rate limiters and before `app.use(hubRouter)` (line 33):

   ```javascript
   // Apply HTML page rate limiter to GET routes
   app.use('/', (req, res, next) => {
     // Only apply to HTML pages (GET requests to non-API routes)
     if (req.method === 'GET' && !req.path.startsWith('/api')) {
       return htmlPageLimiter(req, res, next);
     }
     next();
   });

   // Apply rate limiters to specific API endpoints
   app.use('/api/jobs/:uuid/pay', paymentLimiter);
   app.use('/api/jobs', jobCreationLimiter);
   app.use('/api/register-agent', agentRegistrationLimiter);
   app.use('/api/users', userCreationLimiter);
   app.use('/api/jobs/:uuid/complete', jobCompletionLimiter);

   // Apply read limiter to all other API endpoints
   app.use('/api', apiReadLimiter);
   ```

4. **Add rate limit status to health endpoint** (src/index.js:768-777):

   Replace the health endpoint with:
   ```javascript
   app.get('/health', (req, res) => {
     res.json({
       status: 'healthy',
       agent: 'MrMagoochi',
       version: '0.9.0',
       ai: 'claude-sonnet-4',
       services: Object.keys(PRICING),
       pricing: PRICING,
       rateLimits: {
         htmlPages: '200 req/min per IP',
         apiReads: '100 req/min per IP',
         jobCreation: '10 req/min per IP',
         payment: '5 req/min per IP',
         agentRegistration: '5 req/min per IP',
         jobCompletion: '20 req/min per IP',
         userCreation: '10 req/min per IP'
       }
     });
   });
   ```

**Files Modified**:
- `src/index.js` (rate limiter setup and application)

**Verification**:
- Test job creation endpoint: Should block after 10 requests in 1 minute
- Test payment endpoint: Should block after 5 requests in 1 minute
- Response includes `RateLimit-Limit`, `RateLimit-Remaining`, `RateLimit-Reset` headers
- GET /health shows rate limit configuration

**Commit Message**:
```
feat(09-01): add rate limiting to all API endpoints
```

---

## Task 3: Add Structured Logging with Winston

**Goal**: Replace console.log with Winston structured logging

**What to do**:

1. **Create logger module** `src/logger.js`:
   ```javascript
   const winston = require('winston');

   // Define log format
   const logFormat = winston.format.combine(
     winston.format.timestamp({ format: 'YYYY-MM-DD HH:mm:ss' }),
     winston.format.errors({ stack: true }),
     winston.format.splat(),
     winston.format.json()
   );

   // Create logger instance
   const logger = winston.createLogger({
     level: process.env.LOG_LEVEL || 'info',
     format: logFormat,
     defaultMeta: { service: 'agent-economy-hub' },
     transports: [
       // Console transport for all environments
       new winston.transports.Console({
         format: winston.format.combine(
           winston.format.colorize(),
           winston.format.printf(({ level, message, timestamp, ...metadata }) => {
             let msg = `${timestamp} [${level}] ${message}`;

             // Add metadata if present
             const metaStr = JSON.stringify(metadata);
             if (metaStr !== '{}') {
               msg += ` ${metaStr}`;
             }

             return msg;
           })
         )
       })
     ]
   });

   // Add file transport for production
   if (process.env.NODE_ENV === 'production') {
     logger.add(new winston.transports.File({
       filename: 'logs/error.log',
       level: 'error',
       maxsize: 5242880, // 5MB
       maxFiles: 5
     }));
     logger.add(new winston.transports.File({
       filename: 'logs/combined.log',
       maxsize: 5242880, // 5MB
       maxFiles: 5
     }));
   }

   module.exports = logger;
   ```

2. **Replace console.log with logger in src/index.js**:

   Add import at top (after line 7):
   ```javascript
   const logger = require('./logger');
   ```

   Replace startup logs (lines 863-867):
   ```javascript
   logger.info('Agent Economy Hub started', {
     version: '0.9.0',
     port: PORT,
     ai: 'claude-sonnet-4',
     hasAnthropicKey: !!ANTHROPIC_API_KEY,
     hasDatabaseUrl: !!process.env.DATABASE_URL,
     hasAlchemyKey: !!process.env.ALCHEMY_API_KEY,
     hasReplicateToken: !!process.env.REPLICATE_API_TOKEN
   });
   ```

   Replace error logs (lines 854-856, 870-871):
   ```javascript
   // Line 854-856
   logger.error('Missing required environment variables', { missing });
   logger.error('Please check your .env file and ensure all required variables are set');
   process.exit(1);

   // Line 870-871
   logger.error('Failed to start server', { error: error.message, stack: error.stack });
   process.exit(1);
   ```

3. **Replace console.log/error in src/db.js**:

   Add import at top (after line 1):
   ```javascript
   const logger = require('./logger');
   ```

   Replace console.log (line 127):
   ```javascript
   logger.info('Database schema initialized');
   ```

   Replace console.error (line 129):
   ```javascript
   logger.error('Database initialization failed', { error: error.message, stack: error.stack });
   ```

   Replace console.warn (line 249):
   ```javascript
   logger.warn('Ignoring invalid field in updateJobStatus', { field: key });
   ```

4. **Add request logging middleware** in src/index.js (after CSP header, line 27):
   ```javascript
   // Request logging
   app.use((req, res, next) => {
     const start = Date.now();

     // Log after response is sent
     res.on('finish', () => {
       const duration = Date.now() - start;
       const logData = {
         method: req.method,
         path: req.path,
         status: res.statusCode,
         duration: `${duration}ms`,
         ip: req.ip
       };

       // Log level based on status code
       if (res.statusCode >= 500) {
         logger.error('Request failed', logData);
       } else if (res.statusCode >= 400) {
         logger.warn('Request error', logData);
       } else {
         logger.info('Request completed', logData);
       }
     });

     next();
   });
   ```

5. **Add error logging middleware** (add at end of src/index.js, before start()):
   ```javascript
   // Global error handler
   app.use((err, req, res, next) => {
     logger.error('Unhandled error', {
       error: err.message,
       stack: err.stack,
       path: req.path,
       method: req.method
     });

     res.status(500).json({
       error: 'Internal server error',
       message: process.env.NODE_ENV === 'production' ? 'An error occurred' : err.message
     });
   });
   ```

**Files Modified**:
- `src/logger.js` (created - 55 lines)
- `src/index.js` (logger integration)
- `src/db.js` (logger integration)

**Verification**:
- Startup logs are JSON-formatted with timestamps
- Request logs include method, path, status, duration
- Error logs include stack traces
- GET /health request is logged
- Log level can be controlled via LOG_LEVEL env var

**Commit Message**:
```
feat(09-01): add structured logging with Winston
```

---

## Task 4: Add Graceful Shutdown Handlers

**Goal**: Close database connections and finish in-flight requests before exit

**What to do**:

1. **Add shutdown function in src/db.js** (at end, before module.exports):
   ```javascript
   /**
    * Gracefully close database connection pool
    */
   async function closePool() {
     const logger = require('./logger');
     try {
       await pool.end();
       logger.info('Database connection pool closed');
     } catch (error) {
       logger.error('Error closing database pool', { error: error.message });
       throw error;
     }
   }
   ```

2. **Export closePool** in src/db.js module.exports (line 347):
   ```javascript
   module.exports = {
     pool,
     query,
     initDB,
     closePool, // Add this
     getUser,
     createUser,
     getAgent,
     getAgentByWallet,
     getAllAgents,
     createAgent,
     createSkill,
     getSkillsByAgent,
     getSkill,
     createJob,
     updateJobStatus,
     getJob,
     getJobsByUser,
     getJobsByAgent,
     logWebhookDelivery,
     markJobInProgress
   };
   ```

3. **Add graceful shutdown handler in src/index.js** (replace start() function, lines 844-875):
   ```javascript
   // Track server instance for graceful shutdown
   let server;

   // Graceful shutdown handler
   async function gracefulShutdown(signal) {
     logger.info(`Received ${signal}, starting graceful shutdown`);

     // Stop accepting new connections
     if (server) {
       server.close(() => {
         logger.info('HTTP server closed');
       });
     }

     // Close database pool
     try {
       await db.closePool();
     } catch (error) {
       logger.error('Error during shutdown', { error: error.message });
     }

     logger.info('Graceful shutdown complete');
     process.exit(0);
   }

   // Register shutdown handlers
   process.on('SIGTERM', () => gracefulShutdown('SIGTERM'));
   process.on('SIGINT', () => gracefulShutdown('SIGINT'));

   // Handle uncaught errors
   process.on('uncaughtException', (error) => {
     logger.error('Uncaught exception', { error: error.message, stack: error.stack });
     gracefulShutdown('uncaughtException').then(() => process.exit(1));
   });

   process.on('unhandledRejection', (reason, promise) => {
     logger.error('Unhandled rejection', { reason, promise });
     gracefulShutdown('unhandledRejection').then(() => process.exit(1));
   });

   // Start server
   async function start() {
     // Validate required environment variables
     const required = [
       'DATABASE_URL',
       'ANTHROPIC_API_KEY',
       'ALCHEMY_API_KEY',
       'REPLICATE_API_TOKEN'
     ];

     const missing = required.filter(key => !process.env[key]);
     if (missing.length > 0) {
       logger.error('Missing required environment variables', { missing });
       logger.error('Please check your .env file and ensure all required variables are set');
       process.exit(1);
     }

     try {
       await db.initDB();

       server = app.listen(PORT, () => {
         logger.info('Agent Economy Hub started', {
           version: '0.9.0',
           port: PORT,
           ai: 'claude-sonnet-4',
           hasAnthropicKey: !!ANTHROPIC_API_KEY,
           hasDatabaseUrl: !!process.env.DATABASE_URL,
           hasAlchemyKey: !!process.env.ALCHEMY_API_KEY,
           hasReplicateToken: !!process.env.REPLICATE_API_TOKEN
         });
       });
     } catch (error) {
       logger.error('Failed to start server', { error: error.message, stack: error.stack });
       process.exit(1);
     }
   }

   start();
   ```

4. **Import db.closePool** at top of src/index.js (line 4):
   ```javascript
   const db = require('./db');
   ```

**Files Modified**:
- `src/db.js` (closePool function added)
- `src/index.js` (graceful shutdown handlers added)

**Verification**:
- Press Ctrl+C in terminal: Should log "Received SIGINT, starting graceful shutdown"
- Should log "Database connection pool closed"
- Should log "Graceful shutdown complete"
- Process exits cleanly with code 0
- No hanging connections or unfinished requests

**Commit Message**:
```
feat(09-01): add graceful shutdown handlers for clean termination
```

---

## Task 5: Enhance Environment Validation and Startup Checks

**Goal**: Add comprehensive startup validation with helpful error messages

**What to do**:

1. **Add detailed environment validation** in src/index.js (replace current validation at lines 846-858):
   ```javascript
   // Validate required environment variables with helpful messages
   const required = {
     DATABASE_URL: 'PostgreSQL connection string (e.g., postgresql://user:pass@host:5432/db)',
     ANTHROPIC_API_KEY: 'Anthropic API key for Claude AI (starts with sk-ant-)',
     ALCHEMY_API_KEY: 'Alchemy API key for blockchain RPC (get from alchemy.com)',
     REPLICATE_API_TOKEN: 'Replicate API token for image generation (starts with r8_)'
   };

   const errors = [];
   for (const [key, description] of Object.entries(required)) {
     if (!process.env[key]) {
       errors.push(`  ‚úó ${key}: ${description}`);
     }
   }

   if (errors.length > 0) {
     logger.error('Missing required environment variables:');
     errors.forEach(err => logger.error(err));
     logger.error('Please check your .env file. See .env.example for reference.');
     process.exit(1);
   }
   ```

2. **Add optional environment variables check** (after required validation):
   ```javascript
   // Check optional environment variables
   const optional = {
     PORT: process.env.PORT || 7378,
     NODE_ENV: process.env.NODE_ENV || 'development',
     LOG_LEVEL: process.env.LOG_LEVEL || 'info'
   };

   logger.info('Environment configuration', optional);
   ```

3. **Add startup health checks** (in start() function, after db.initDB()):
   ```javascript
   // Test database connection
   try {
     await db.query('SELECT 1');
     logger.info('Database connection verified');
   } catch (error) {
     logger.error('Database connection test failed', { error: error.message });
     throw error;
   }

   // Verify AI service key format
   if (!ANTHROPIC_API_KEY.startsWith('sk-ant-')) {
     logger.warn('ANTHROPIC_API_KEY format unexpected (should start with sk-ant-)');
   }

   // Verify Replicate token format
   if (!process.env.REPLICATE_API_TOKEN.startsWith('r8_')) {
     logger.warn('REPLICATE_API_TOKEN format unexpected (should start with r8_)');
   }
   ```

4. **Add readiness endpoint** in src/index.js (after /health endpoint):
   ```javascript
   // Readiness check (for Railway health checks)
   app.get('/ready', async (req, res) => {
     try {
       // Test database connection
       await db.query('SELECT 1');
       res.json({ ready: true, timestamp: new Date().toISOString() });
     } catch (error) {
       logger.error('Readiness check failed', { error: error.message });
       res.status(503).json({
         ready: false,
         error: 'Database connection failed',
         timestamp: new Date().toISOString()
       });
     }
   });
   ```

**Files Modified**:
- `src/index.js` (enhanced validation and health checks)

**Verification**:
- Start server with missing env var: Should show helpful error message
- Start server with all env vars: Should log "Database connection verified"
- GET /ready should return 200 with {"ready":true}
- Logs show environment configuration on startup

**Commit Message**:
```
feat(09-01): enhance environment validation and startup health checks
```

---

## Task 6: Add Operational Monitoring Endpoints

**Goal**: Add endpoints for monitoring rate limits, database status, and system health

**What to do**:

1. **Create operational stats module** `src/stats.js`:
   ```javascript
   const logger = require('./logger');
   const startTime = Date.now();

   // Track request counts
   const requestCounts = {
     total: 0,
     byMethod: {},
     byPath: {},
     byStatus: {}
   };

   function incrementRequestCount(method, path, status) {
     requestCounts.total++;
     requestCounts.byMethod[method] = (requestCounts.byMethod[method] || 0) + 1;
     requestCounts.byPath[path] = (requestCounts.byPath[path] || 0) + 1;
     requestCounts.byStatus[status] = (requestCounts.byStatus[status] || 0) + 1;
   }

   function getStats() {
     const uptime = Date.now() - startTime;
     return {
       uptime: {
         ms: uptime,
         seconds: Math.floor(uptime / 1000),
         minutes: Math.floor(uptime / 60000),
         hours: Math.floor(uptime / 3600000)
       },
       requests: requestCounts,
       memory: process.memoryUsage(),
       nodeVersion: process.version,
       platform: process.platform
     };
   }

   function resetStats() {
     requestCounts.total = 0;
     requestCounts.byMethod = {};
     requestCounts.byPath = {};
     requestCounts.byStatus = {};
     logger.info('Stats reset');
   }

   module.exports = {
     incrementRequestCount,
     getStats,
     resetStats
   };
   ```

2. **Integrate stats tracking** in src/index.js request logger (Task 3):

   Add import at top:
   ```javascript
   const stats = require('./stats');
   ```

   Update request logging middleware (after line 27):
   ```javascript
   // Request logging and stats
   app.use((req, res, next) => {
     const start = Date.now();

     res.on('finish', () => {
       const duration = Date.now() - start;

       // Track stats
       stats.incrementRequestCount(req.method, req.path, res.statusCode);

       const logData = {
         method: req.method,
         path: req.path,
         status: res.statusCode,
         duration: `${duration}ms`,
         ip: req.ip
       };

       if (res.statusCode >= 500) {
         logger.error('Request failed', logData);
       } else if (res.statusCode >= 400) {
         logger.warn('Request error', logData);
       } else {
         logger.info('Request completed', logData);
       }
     });

     next();
   });
   ```

3. **Add stats endpoint** in src/index.js (after /ready endpoint):
   ```javascript
   // Stats endpoint (for operational monitoring)
   app.get('/api/stats', async (req, res) => {
     try {
       const dbStats = await db.query('SELECT COUNT(*) as job_count FROM jobs');
       const agentStats = await db.query('SELECT COUNT(*) as agent_count FROM agents WHERE is_active = true');

       res.json({
         system: stats.getStats(),
         database: {
           totalJobs: parseInt(dbStats.rows[0].job_count),
           activeAgents: parseInt(agentStats.rows[0].agent_count)
         },
         timestamp: new Date().toISOString()
       });
     } catch (error) {
       logger.error('Stats endpoint error', { error: error.message });
       res.status(500).json({ error: 'Failed to fetch stats' });
     }
   });
   ```

4. **Update /health endpoint** to include more details (replace existing /health):
   ```javascript
   app.get('/health', async (req, res) => {
     try {
       // Test DB connection
       await db.query('SELECT 1');

       const uptime = stats.getStats().uptime;

       res.json({
         status: 'healthy',
         uptime: `${uptime.hours}h ${uptime.minutes % 60}m ${uptime.seconds % 60}s`,
         agent: 'MrMagoochi',
         version: '0.9.0',
         ai: 'claude-sonnet-4',
         services: Object.keys(PRICING).length,
         database: 'connected',
         rateLimits: {
           htmlPages: '200 req/min per IP',
           apiReads: '100 req/min per IP',
           jobCreation: '10 req/min per IP',
           payment: '5 req/min per IP',
           agentRegistration: '5 req/min per IP',
           jobCompletion: '20 req/min per IP',
           userCreation: '10 req/min per IP'
         },
         timestamp: new Date().toISOString()
       });
     } catch (error) {
       logger.error('Health check database connection failed', { error: error.message });
       res.status(503).json({
         status: 'unhealthy',
         database: 'disconnected',
         error: error.message,
         timestamp: new Date().toISOString()
       });
     }
   });
   ```

**Files Modified**:
- `src/stats.js` (created - 50 lines)
- `src/index.js` (stats integration, enhanced /health, /api/stats endpoint)

**Verification**:
- GET /health returns uptime and database status
- GET /ready returns 200 when DB connected
- GET /api/stats returns request counts and system stats
- Stats increment after making requests
- Health check fails gracefully if DB disconnected

**Commit Message**:
```
feat(09-01): add operational monitoring endpoints and stats tracking
```

---

## Verification

**After All Tasks Complete**:

1. **Test Rate Limiting**:
   ```bash
   # Test job creation rate limit (should block after 10 requests)
   for i in {1..15}; do
     curl -X POST http://localhost:7378/api/jobs \
       -H "Content-Type: application/json" \
       -d '{"agentId":1,"skillId":1,"input":"test"}' \
       -w "\nStatus: %{http_code}\n"
   done
   ```
   Expected: First 10 succeed, last 5 return 429 (Too Many Requests)

2. **Test Structured Logging**:
   ```bash
   # Start server and check logs
   npm start
   ```
   Expected: JSON-formatted logs with timestamps, levels, and metadata

3. **Test Graceful Shutdown**:
   ```bash
   # Start server, then press Ctrl+C
   npm start
   # Press Ctrl+C
   ```
   Expected:
   - Logs "Received SIGINT, starting graceful shutdown"
   - Logs "Database connection pool closed"
   - Logs "Graceful shutdown complete"
   - Process exits cleanly

4. **Test Health Endpoints**:
   ```bash
   # Health check
   curl http://localhost:7378/health

   # Readiness check
   curl http://localhost:7378/ready

   # Stats endpoint
   curl http://localhost:7378/api/stats
   ```
   Expected:
   - /health returns 200 with database:connected
   - /ready returns 200 with ready:true
   - /api/stats returns system and database stats

5. **Test Environment Validation**:
   ```bash
   # Start with missing env var
   unset ANTHROPIC_API_KEY
   npm start
   ```
   Expected: Helpful error message with description of missing variable

6. **Check Rate Limit Headers**:
   ```bash
   curl -i http://localhost:7378/api/jobs
   ```
   Expected: Response includes headers:
   - `RateLimit-Limit: 10`
   - `RateLimit-Remaining: 9`
   - `RateLimit-Reset: <timestamp>`

**Success Criteria**:
- ‚úÖ All API endpoints have rate limiting
- ‚úÖ Rate limits trigger correctly (429 response)
- ‚úÖ Logs are structured JSON with timestamps
- ‚úÖ Graceful shutdown closes DB pool cleanly
- ‚úÖ Health endpoints return correct status
- ‚úÖ Environment validation shows helpful errors
- ‚úÖ Stats tracking works across requests

---

## Success Criteria

- [ ] express-rate-limit and winston packages installed
- [ ] Rate limiting applied to all API endpoints with tiered limits
- [ ] Rate limit headers (RateLimit-*) present in responses
- [ ] Structured logging with Winston (JSON format, timestamps, levels)
- [ ] Request logging includes method, path, status, duration
- [ ] Graceful shutdown handlers for SIGTERM and SIGINT
- [ ] Database pool closes cleanly on shutdown
- [ ] Enhanced environment validation with helpful error messages
- [ ] /health endpoint shows database status and uptime
- [ ] /ready endpoint tests database connection
- [ ] /api/stats endpoint returns operational metrics
- [ ] All changes committed with proper commit messages
- [ ] No breaking changes to existing API contracts

---

## Output

**Packages Added**:
- `express-rate-limit@^7.1.5` - Rate limiting middleware
- `winston@^3.11.0` - Structured logging library

**Files Created**:
- `src/logger.js` (~55 lines) - Winston logger configuration
- `src/stats.js` (~50 lines) - Operational stats tracking

**Files Modified**:
- `package.json` - Dependencies added
- `src/index.js` - Rate limiting, logging, graceful shutdown, health endpoints
- `src/db.js` - Logger integration, closePool function

**Total Lines Added**: ~400 lines (middleware, logging, monitoring)

**API Changes**: None (all changes are additive, no breaking changes)

**Estimated Complexity**: Low-Medium (middleware configuration, logging setup)

**Estimated Time**: ~1.5 hours

---

*Plan created: 2026-02-03 for Phase 9: Rate Limiting & Basic Ops*
